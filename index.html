<div class="action-bar">
    <button id="loadBtn" class="btn btn-primary" onclick="processData()">Load Data</button>
    <button class="btn btn-primary" onclick="exportData()" style="background-color: #28a745;">Download USER.DAT</button>
    <button class="btn btn-secondary" onclick="exportKML()" style="background-color: #6f42c1; color: white;">Export KML</button>
    <button class="btn btn-secondary" onclick="copyToClipboard()">Copy to Clipboard (CSV)</button>
    <button class="btn btn-danger" onclick="removeAll()">Clear All</button>
</div>

<input type="file" id="fileInput" accept=".dat,.csv,.txt,.kml">

<script>
/* --- New KML Logic for v5.35 --- */

function processData() {
    const fileInput = document.getElementById('fileInput');
    const bulkInput = document.getElementById('bulkInput').value.trim();
    
    if (fileInput.files.length > 0) {
        const file = fileInput.files[0];
        const reader = new FileReader();
        const ext = file.name.toLowerCase().split('.').pop();

        if (ext === 'dat') {
            reader.onload = (e) => decodeBinary(e.target.result);
            reader.readAsArrayBuffer(file);
        } else if (ext === 'kml') {
            reader.onload = (e) => parseKML(e.target.result);
            reader.readAsText(file);
        } else {
            reader.onload = (e) => parseText(e.target.result);
            reader.readAsText(file);
        }
    } else if (bulkInput) {
        parseText(bulkInput);
    }
}

function parseKML(xmlText) {
    try {
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(xmlText, "text/xml");
        const placemarks = xmlDoc.getElementsByTagName("Placemark");
        let waypoints = [];

        for (let i = 0; i < placemarks.length; i++) {
            const pm = placemarks[i];
            const name = pm.getElementsByTagName("name")[0]?.textContent || "WP" + i;
            const coordsNode = pm.getElementsByTagName("coordinates")[0];
            
            if (coordsNode) {
                // KML coordinates are Lon,Lat,Elev
                const parts = coordsNode.textContent.trim().split(",");
                if (parts.length >= 2) {
                    waypoints.push({
                        id: name.substring(0, 5).toUpperCase().replace(/\s/g, ''),
                        name: name.substring(0, 12).toUpperCase(),
                        lat: parseFloat(parts[1]).toFixed(5),
                        lon: parseFloat(parts[0]).toFixed(5),
                        elev: Math.round(parseFloat(parts[2] || 0)),
                        brg: 0
                    });
                }
            }
        }
        populateTable(waypoints);
    } catch (e) {
        alert("KML Parse Error: " + e.message);
    }
}

function exportKML() {
    const rows = document.querySelectorAll('#wpTable tbody tr');
    let kml = `<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2">
  <Document>
    <name>Genesys Export</name>`;

    rows.forEach(row => {
        const inputs = row.querySelectorAll('input');
        if (inputs[0].value.trim()) {
            kml += `
    <Placemark>
      <name>${inputs[0].value}</name>
      <description>${inputs[1].value}</description>
      <Point>
        <coordinates>${inputs[3].value},${inputs[2].value},${inputs[4].value}</coordinates>
      </Point>
    </Placemark>`;
        }
    });

    kml += `
  </Document>
</kml>`;

    const blob = new Blob([kml], { type: "application/vnd.google-earth.kml+xml" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "waypoints.kml";
    a.click();
    URL.revokeObjectURL(url);
}
</script>
