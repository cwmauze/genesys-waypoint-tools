<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Genesys IDU Waypoint and Route Tools</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root {
            --bg: #18191a; --card: #242526; --text: #e4e6eb; --border: #3e4042;
            --primary: #478df5; --secondary: #3a3b3c; --danger: #fb6161;
            --success: #28a745; --garmin: #007cc3; --dispatch: #f39c12;
            --earth: #2d81ff; --link: #a3c7ff;
            --header-sep: rgba(255, 255, 255, 0.1);
        }
        [data-theme="light"] {
            --bg: #f0f2f5; --card: #ffffff; --text: #1c1e21; --border: #dadde1;
            --primary: #1a73e8; --secondary: #e4e6eb; --danger: #fa3e3e;
            --link: #1a73e8;
            --header-sep: rgba(0, 0, 0, 0.1);
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 20px; background: var(--bg); color: var(--text); transition: background 0.3s; }
        .container { max-width: 1500px; margin: auto; background: var(--card); padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); position: relative; }
        .version-subtitle { font-size: 11px; color: #90949c; margin-top: 4px; display: inline-block; font-weight: normal; cursor: pointer; text-decoration: underline; }
        .contact-link, .project-link { font-size: 11px; color: #90949c; margin-left: 15px; text-decoration: underline; }
        .header-row { display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 2px solid var(--border); padding-bottom: 10px; margin-bottom: 20px; }
        h2 { margin: 0; color: var(--primary); line-height: 1; }
        
        .top-info-grid { display: grid; grid-template-columns: 1.5fr 1fr; gap: 20px; margin-bottom: 20px; }
        .instructions { background: rgba(71, 141, 245, 0.1); padding: 15px; border-radius: 8px; border-left: 5px solid var(--primary); font-size: 14px; line-height: 1.5; height: 100%; box-sizing: border-box; }
        .session-status-card { background: var(--secondary); padding: 15px; border-radius: 8px; border: 1px solid var(--border); font-size: 12px; height: 100%; box-sizing: border-box; }
        
        .action-bar { 
            background: var(--card) !important;
            padding: 15px; border-radius: 8px; margin-bottom: 20px; 
            display: none; 
            flex-wrap: wrap; gap: 10px; align-items: center;
            position: sticky; top: 0; z-index: 1002; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            border-bottom: 3px solid var(--primary);
        }

        table { width: 100%; border-collapse: collapse; margin: 20px 0; font-size: 12px; table-layout: fixed; border: 1px solid var(--border); }
        th, td { border: 1px solid var(--border); padding: 8px; text-align: left; vertical-align: middle; }
        
        thead th { 
            background-color: var(--secondary) !important;
            font-weight: 600; font-size: 11px; 
            user-select: none; line-height: 1.2; 
            position: sticky; 
            z-index: 1001; 
            padding-top: 6px; padding-bottom: 6px;
            border-right: 1px solid var(--header-sep);
        }
        thead th:last-child { border-right: none; }

        .clickable-header { cursor: pointer; transition: background 0.2s; }
        .clickable-header:hover { background-color: var(--border) !important; color: var(--primary); }
        .header-instruction { display: block; font-size: 9px; font-weight: 400; opacity: 0.6; margin-top: 2px; }

        .action-col { display: none; }
        input { width: 95%; padding: 6px; border: 1px solid var(--border); border-radius: 4px; font-size: 12px; background: var(--card); color: var(--text); box-sizing: border-box; }
        .btn { padding: 10px 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; margin-right: 5px; margin-bottom: 5px; transition: all 0.2s ease; text-align: center; color: white; display: inline-block; vertical-align: middle; }
        .btn:hover { filter: brightness(1.2); transform: translateY(-1px); }
        .btn span { display: block; font-size: 10px; font-weight: 400; opacity: 0.9; margin-top: 2px; }
        .btn-secondary { background: var(--secondary); color: var(--text); }
        .btn-danger { background: var(--danger); }
        a { color: var(--link); text-decoration: none; font-weight: 500; font-size: 10px; }
        .separator { margin: 0 8px; color: #888; font-weight: bold; pointer-events: none; }
        
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); }
        .modal-content { background: var(--card); margin: 5% auto; padding: 25px; border: 1px solid var(--border); width: 60%; border-radius: 12px; color: var(--text); max-height: 80vh; display: flex; flex-direction: column; }
        .modal-body { overflow-y: auto; font-size: 13px; line-height: 1.6; padding-right: 10px; flex-grow: 1; }
        
        #mapOverlay { display: none; position: fixed; top: 5%; left: 5%; width: 90%; height: 80%; background: var(--card); z-index: 3000; border: 2px solid var(--primary); border-radius: 12px; }
        #map { width: 100%; height: calc(100% - 60px); }

        .drag-handle { cursor: grab; text-align: center; color: var(--primary); font-size: 16px; user-select: none; }
        .drag-handle:active { cursor: grabbing; }
        tbody tr { transition: transform 0.1s ease, background 0.2s ease; }
        tr.dragging { opacity: 0.2; }
        tr.drag-over { border-top: 3px solid var(--primary) !important; background: rgba(71, 141, 245, 0.05); }
        #drag-ghost { position: fixed; top: -1000px; left: -1000px; background: var(--card); border: 2px solid var(--primary); border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.4); pointer-events: none; z-index: 5000; opacity: 0.95; }
        #drag-ghost table { margin: 0; }
    </style>
</head>
<body onload="startClock(); initStickyObserver();" onclick="hideContextMenu()">

<div id="drag-ghost"></div>

<div class="container">
    <div class="header-row">
        <div>
            <h2>Genesys IDU Waypoint and Route Tools</h2>
            <span class="version-subtitle" onclick="showHistory()">v8.0 (View History)</span>
            <a href="mailto:cistern_fob3m@icloud.com?subject=IDU%20Tool%20Feedback" class="contact-link">Contact / Feedback</a>
            <a href="https://github.com/cwmauze/genesys-waypoint-tools/tree/main" target="_blank" class="project-link">GitHub Project Home</a>
        </div>
        <button class="btn btn-secondary" onclick="toggleTheme()" id="themeBtn">☀️ Light Mode</button>
    </div>

    <div style="font-size: 13px; color: #90949c; margin-bottom: 25px; line-height: 1.5; max-width: 1000px; border-left: 2px solid var(--border); padding-left: 15px;">
        This tool serves as a necessary interface for generating navigation database files, as Genesys Aerosystems does not provide a standalone utility for this process. It automates the extraction and validation of waypoint identifiers and coordinates from diverse sources into the specific binary structure required for Genesys and Garmin avionics uploads.
    </div>
    
    <div class="top-info-grid">
        <div class="instructions">
            <strong>Pre-Flight Data Prep:</strong><br>
            1. Select a file (<strong>Genesys user.dat / .rte</strong>, <strong>Garmin user.wpt</strong>, <strong>.csv</strong>, <strong>.kml</strong>) or paste bulk data. The table will populate automatically.<br>
            2. Parser normalizes: <strong>DD</strong> (35.1234), <strong>DDM</strong> (35° 07.40' N), <strong>DMS</strong> (35° 07' 24" N).<br>
            3. Verify the table and export.
            <div style="font-size: 11px; margin-top: 8px;">
                <strong>References:</strong> 
                <a href="https://www.moog.com/products/avionics/aircraft-avionics/pilot-guides.html" target="_blank">Genesys IDU Guides</a> | 
                <a href="https://support.garmin.com/en-US/?faq=3mcdU37gXi88ipwjJIxJo7" target="_blank">Garmin GTN Guide</a>
            </div>
        </div>

        <div class="session-status-card">
            <div style="font-weight: bold; color: var(--primary); margin-bottom: 10px; text-transform: uppercase; font-size: 10px; display: flex; justify-content: space-between;">
                <span>Session status</span>
                <span id="local-clock" style="color: var(--text);">00:00:00</span>
            </div>
            <div style="margin-bottom:6px; display:flex; justify-content:space-between;"><span>Last action:</span> <span id="last-action">Ready</span></div>
            <div style="margin-bottom:6px; display:flex; justify-content:space-between;"><span>Current total:</span> <span id="wp-count-display">0</span></div>
            <div style="display:flex; justify-content:space-between;"><span>System status:</span> <span id="sys-status" class="status-ready">● Ready</span></div>
        </div>
    </div>

    <div style="display: flex; gap: 20px; margin-bottom: 20px;">
        <div style="flex: 1;"><label style="font-size: 13px; font-weight: 600;">Option A: Load file</label><input type="file" id="fileInput" accept=".dat,.csv,.txt,.kml,.wpt,.xml,.rte" onchange="processFile()"></div>
        <div style="flex: 2;"><label style="font-size: 13px; font-weight: 600;">Option B: Bulk paste</label><textarea id="bulkInput" style="width:100%; height:42px; border-radius:6px; border:1px solid var(--border); background:var(--card); color:var(--text); padding: 5px;" placeholder="Paste coordinates or dirty spreadsheet data here..." oninput="debouncePaste()"></textarea></div>
    </div>

    <div class="action-bar" id="actionBar">
        <button class="btn" onclick="showMap()" style="background-color: var(--earth);">Preview on Map <span>STREET / SAT / SECTIONAL</span></button>
        <span style="font-size: 12px; font-weight: bold; color: var(--primary); margin-right: 10px; margin-left: 10px;">EXPORT:</span>
        <button class="btn" onclick="validateAndExportGenesys()" style="background-color: var(--success);">Download user.dat <span>GENESYS IDU</span></button>
        <button class="btn" onclick="exportToRTE()" style="background-color: #9b59b6;">Download .RTE <span>FLIGHT PLAN</span></button>
        <button class="btn" onclick="validateAndExportGarmin()" style="background-color: var(--garmin);">Download user.wpt <span>GARMIN GNS / GTN</span></button>
        <button class="btn" onclick="exportCompleteFlight()" style="background-color: var(--dispatch);">Download CSV <span>COMPLETE FLIGHT</span></button>
        <button class="btn btn-secondary" onclick="exportKML()" style="background-color: #6f42c1; color: white;">Export KML <span>GOOGLE EARTH</span></button>
        <div style="flex-grow: 1;"></div>
        <button class="btn btn-danger" onclick="removeAll()">CLEAR ALL DATA</button>
    </div>
    
    <table id="wpTable">
        <thead id="tableHeader">
            <tr id="headerRow">
                <th style="width: 3%;"></th>
                <th style="width: 10%;">Identifier</th>
                <th style="width: 14%;">Name</th>
                <th style="width: 12%;" class="clickable-header" onclick="toggleCoordinateFormat()">
                    <span id="header-lat">Latitude (DD)</span>
                    <span class="header-instruction">Click to toggle units</span>
                </th>
                <th style="width: 12%;" class="clickable-header" onclick="toggleCoordinateFormat()">
                    <span id="header-lon">Longitude (DD)</span>
                    <span class="header-instruction">Click to toggle units</span>
                </th>
                <th style="width: 10%;">Elevation<br>(Ft. MSL)</th>
                <th style="width: 12%;">Approach Bearing<br>(Genesys)</th>
                <th style="width: 27%;" class="action-col">View waypoint in</th>
            </tr>
        </thead>
        <tbody id="table-body"></tbody>
    </table>

    <div style="display: flex; gap: 10px; margin-top: 10px;">
        <button class="btn btn-secondary" onclick="addRows(1)">+ Add 1 row</button>
        <button class="btn btn-secondary" onclick="addRows(5)">+ Add 5 rows</button>
        <button class="btn btn-secondary" onclick="addRows(10)">+ Add 10 rows</button>
    </div>

    <div id="historyModal" class="modal">
        <div class="modal-content">
            <h3 style="margin-top:0; border-bottom: 1px solid var(--border); padding-bottom: 10px;">Project version history</h3>
            <div class="modal-body" id="modal-body">
                <strong>v8.0:</strong> Consolidated Build. Integrated Genesys .RTE Import/Export (Phantom Record Architecture).<br>
                <strong>v7.6.5:</strong> Strict Garmin user.wpt alignment (Headerless, 4 columns, fixed precision); Removed elevation/comments from Garmin.<br>
                <strong>v7.6.4:</strong> Action Bar hidden until data is present; Added matter-of-fact description.<br>
                <strong>v7.6.3:</strong> Reduced header height; Click-to-Toggle subtitle; Header separators.<br>
                <strong>v7.6.0:</strong> Integrated Coordinate Toggle into column headers.<br>
                <strong>v7.1 Stable:</strong> Core logic synchronized with binary engine.
            </div>
            <button class="btn btn-secondary" style="margin-top:20px" onclick="closeHistory()">Close</button>
        </div>
    </div>

    <div id="mapOverlay">
        <div id="map"></div>
        <div style="padding: 10px; background: var(--secondary); text-align: right;"><button class="btn btn-danger" onclick="hideMap()">Close map</button></div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// --- CONSTANTS ---
const RECORD_SIZE = 88, HEADER_SIZE = 72, TARGET_FILE_SIZE = 88016; // DAT Constants
const RTE = { // RTE Constants
    FILE_SIZE: 4776,
    HEADER_SIZE: 56,
    REC_SIZE: 72,
    NAME_START: 3032,
    NAME_SIZE: 31,
    CRC_OFFSET: 4772
};

let leafletMap = null, markerLayer = null, pasteTimer, draggedRow = null;
let coordFormat = 'DD'; 
const tbody = document.getElementById('table-body');

function initStickyObserver() {
    const actionBar = document.getElementById('actionBar');
    const headerCells = document.querySelectorAll('#tableHeader th');
    const observer = new ResizeObserver(entries => {
        if (entries[0]) {
            const height = entries[0].target.offsetHeight; 
            headerCells.forEach(th => th.style.top = height + 'px');
        }
    });
    observer.observe(actionBar);
}

function startClock() { setInterval(() => { document.getElementById('local-clock').innerText = new Date().toLocaleTimeString('en-GB', { hour12: false }); }, 1000); }
function logAction(action, source, statusText) { 
    document.getElementById('last-action').innerText = action + " (" + new Date().toLocaleTimeString('en-GB', { hour12: false }) + ")"; 
    document.getElementById('wp-count-display').innerText = tbody.querySelectorAll('tr').length; 
    if(statusText) document.getElementById('sys-status').innerText = "● " + statusText;
}

function resetCoordinateUI() {
    coordFormat = 'DD';
    document.getElementById('header-lat').innerText = "Latitude (DD)";
    document.getElementById('header-lon').innerText = "Longitude (DD)";
}

function toggleCoordinateFormat() {
    const formats = ['DD', 'DDM', 'DMS'];
    let idx = formats.indexOf(coordFormat);
    coordFormat = formats[(idx + 1) % formats.length];
    document.getElementById('header-lat').innerText = `Latitude (${coordFormat})`;
    document.getElementById('header-lon').innerText = `Longitude (${coordFormat})`;
    tbody.querySelectorAll('tr').forEach(row => {
        const inputs = row.querySelectorAll('input');
        if (inputs.length >= 4) {
            const lat = parseCoordinate(inputs[2].value);
            const lon = parseCoordinate(inputs[3].value);
            inputs[2].value = formatCoord(lat, true);
            inputs[3].value = formatCoord(lon, false);
        }
    });
}

function formatCoord(val, isLat) {
    const num = parseFloat(val);
    if (isNaN(num)) return val;
    const abs = Math.abs(num);
    const deg = Math.floor(abs);
    const dir = isLat ? (num >= 0 ? 'N' : 'S') : (num >= 0 ? 'E' : 'W');
    if (coordFormat === 'DD') return num.toFixed(6);
    if (coordFormat === 'DDM') {
        const min = ((abs - deg) * 60).toFixed(3);
        return `${deg}° ${min}' ${dir}`;
    }
    if (coordFormat === 'DMS') {
        const totalSec = (abs - deg) * 3600;
        const min = Math.floor(totalSec / 60);
        const sec = (totalSec % 60).toFixed(1);
        return `${deg}° ${min}' ${sec}" ${dir}`;
    }
}

function validateAndExportGenesys() {
    const rows = tbody.querySelectorAll('tr');
    const MAX_CAPACITY = 998, MAX_ID_LEN = 5, MAX_NAME_LEN = 12;
    if (rows.length > MAX_CAPACITY) alert(`Capacity Warning:\nThis list contains ${rows.length} waypoints.\nThe IDU system can only reliably load ${MAX_CAPACITY}.`);
    let longIds = [], longNames = [];
    rows.forEach(r => {
        const inp = r.querySelectorAll('input');
        if (inp.length > 0) {
            const id = inp[0].value.trim(), name = inp[1].value.trim();
            if (id.length > MAX_ID_LEN) longIds.push(id);
            if (name.length > MAX_NAME_LEN) longNames.push(name);
        }
    });
    let msg = "";
    if (longIds.length > 0) msg += `Identifier Warning (Genesys):\n${longIds.length} identifiers exceed 5 chars and will be truncated.\n\n`;
    if (longNames.length > 0) msg += `Name Warning (Genesys):\n${longNames.length} names exceed 12 chars.\n\n`;
    if (msg !== "" && !confirm(msg + "Proceed with export?")) return;
    checkAndExportGenesys();
}

function validateAndExportGarmin() {
    const rows = tbody.querySelectorAll('tr'), MAX_ID_LEN = 6, MAX_NAME_LEN = 25;
    let longIds = [], longNames = [];
    rows.forEach(r => { 
        const inp = r.querySelectorAll('input');
        if (inp.length > 1) {
            if (inp[0].value.trim().length > MAX_ID_LEN) longIds.push(inp[0].value.trim());
            if (inp[1].value.trim().length > MAX_NAME_LEN) longNames.push(inp[1].value.trim()); 
        }
    });
    let msg = "";
    if (longIds.length > 0) msg += `Identifier Warning (Garmin):\n${longIds.length} identifiers exceed 6 chars and will be truncated.\n\n`;
    if (longNames.length > 0) msg += `Comment Warning (Garmin):\n${longNames.length} comments exceed 25 chars and will be truncated.\n\n`;
    if (msg !== "" && !confirm(msg + "Proceed?")) return;
    checkAndExportGarmin();
}

function checkAndExportGarmin() {
    let csv = ""; // v7.6.5 Strictly headerless
    tbody.querySelectorAll('tr').forEach(r => {
        const inp = r.querySelectorAll('input');
        if (inp.length >= 4) {
            const id = inp[0].value.trim().toUpperCase().substring(0, 6);
            const comment = inp[1].value.trim().toUpperCase().substring(0, 25);
            const lat = parseFloat(parseCoordinate(inp[2].value)).toFixed(9);
            const lon = parseFloat(parseCoordinate(inp[3].value)).toFixed(8);
            // Col A: ID, Col B: Comment, Col C: Lat, Col D: Lon
            csv += `${id},${comment},${lat},${lon}\n`;
        }
    });
    downloadBlob(new Blob([csv], {type: 'text/csv'}), "user.wpt");
    logAction("Exported Garmin", "user.wpt", "Success");
}

function smartParse(text) {
    const lines = text.split(/\r?\n/), wps = [];
    const coordPattern = /(-?\d{1,3}[°\s\-\.][0-6]?\d[\s\-\.][0-6]?\d?\.?\d*[N|S|E|W]?)|(-?\d{1,3}\.\d{4,})/gi;
    lines.forEach(line => {
        const clean = line.trim();
        if (!clean || clean.length < 10) return;
        const matches = clean.match(coordPattern);
        if (matches && matches.length >= 2) {
            const lat = parseCoordinate(matches[0]), lon = parseCoordinate(matches[1]);
            const fIdx = clean.indexOf(matches[0]), prefix = clean.substring(0, fIdx).trim();
            let id = "", name = "";
            if (prefix) {
                const words = prefix.split(/\s+/), avMatch = prefix.match(/\b(?=[A-Z]*\d)(?=[0-9]*[A-Z])[A-Z0-9]{3,5}\b/i);
                if (avMatch) { id = avMatch[0].toUpperCase(); name = prefix.replace(id, '').trim() || id; } 
                else if (words[0].length <= 5 && words[0] === words[0].toUpperCase()) { id = words[0]; name = words.slice(1).join(' ') || id; }
                else { id = words[0].substring(0, 5).toUpperCase(); name = prefix; }
            }
            wps.push({ id: id || "WP", name: name || "Waypoint", lat, lon, elev: 0, brg: 0 });
        }
    });
    if (wps.length > 0) populateTable(wps);
}

function processFile() {
    const f = document.getElementById('fileInput');
    if (f.files.length > 0) {
        resetCoordinateUI();
        const file = f.files[0], reader = new FileReader(), ext = file.name.toLowerCase().split('.').pop();
        reader.onload = e => {
            if (ext === 'dat') decodeBinary(e.target.result);
            else if (ext === 'rte') decodeRTE(e.target.result); // NEW RTE HANDLER
            else if (ext === 'kml' || ext === 'xml') parseKML(e.target.result);
            else smartParse(e.target.result);
            logAction("File loaded", file.name, "Success");
        };
        ext === 'dat' || ext === 'rte' ? reader.readAsArrayBuffer(file) : reader.readAsText(file);
    }
}

// --- RTE IMPORTER (Phantom Record / N+1 Shift) ---
function decodeRTE(buf) {
    const view = new DataView(buf);
    const bytes = new Uint8Array(buf);
    
    const count = view.getUint32(0, true);
    if (count <= 0 || count > 200) { alert("Invalid Count: " + count); return; }
    
    const wps = [];
    for (let i = 0; i < count; i++) {
        // COORDINATES are in Record 'i'
        let coordOffset = RTE.HEADER_SIZE + (i * RTE.REC_SIZE);
        let lat = view.getFloat64(coordOffset + 24, true);
        let lon = view.getFloat64(coordOffset + 32, true);

        // DESCRIPTION is in Name Block 'i'
        let nameOffset = RTE.NAME_START + (i * RTE.NAME_SIZE);
        let name = readRTEString(bytes, nameOffset, RTE.NAME_SIZE);

        // ID is in Record 'i+1' (Phantom Record)
        let idOffset = RTE.HEADER_SIZE + ((i + 1) * RTE.REC_SIZE) + 8;
        let id = readRTEString(bytes, idOffset, 6);

        if (!id) id = "WP " + (i + 1);
        
        wps.push({ id: id, name: name, lat: lat.toFixed(6), lon: lon.toFixed(6), elev: 0, brg: 0 });
    }
    populateTable(wps);
}

// --- RTE EXPORTER (Phantom Record / N+1 Shift) ---
function exportToRTE() {
    const rows = [...tbody.querySelectorAll('tr')];
    if (rows.length < 2) return alert("RTE Export requires at least 2 waypoints (Start/End).");

    let buffer = new ArrayBuffer(RTE.FILE_SIZE);
    let view = new DataView(buffer);
    
    // 1. Header: Count
    view.setUint32(0, rows.length, true);

    rows.forEach((r, i) => {
        const inp = r.querySelectorAll('input');
        const id = inp[0].value.toUpperCase().trim();
        const nm = inp[1].value.toUpperCase().trim();
        const lat = parseFloat(parseCoordinate(inp[2].value));
        const lon = parseFloat(parseCoordinate(inp[3].value));
        
        let currentRecOff = RTE.HEADER_SIZE + (i * RTE.REC_SIZE);
        
        // Origin Flag (Record 0 Only)
        if (i === 0) {
            view.setUint8(currentRecOff, 0xB3);
            view.setUint8(currentRecOff + 1, 0x01);
        } else {
            view.setUint8(currentRecOff, 0x00);
            view.setUint8(currentRecOff + 1, 0x00);
        }

        // ID WRITING (Write to Record N+1)
        let nextRecOff = RTE.HEADER_SIZE + ((i + 1) * RTE.REC_SIZE);
        writeRTEString(view, nextRecOff + 8, id, 6, true); // forceNull=true

        // Write "K7" to Next Record (forceNull=false)
        writeRTEString(view, nextRecOff + 14, "K7", 2, false); //

        // COORDINATES (Write to Record N)
        view.setFloat64(currentRecOff + 24, lat, true);
        view.setFloat64(currentRecOff + 32, lon, true);
        view.setFloat32(currentRecOff + 40, 4.0, true);

        // Write "K7" to Current Record (forceNull=false)
        writeRTEString(view, currentRecOff + 14, "K7", 2, false); //

        // Name Block
        let nameOff = RTE.NAME_START + (i * RTE.NAME_SIZE);
        writeRTEString(view, nameOff, nm, RTE.NAME_SIZE, true); // forceNull=true
    });

    // CRC32
    let crc = calculateRTECRC(new Uint8Array(buffer).slice(0, RTE.CRC_OFFSET));
    view.setUint32(RTE.CRC_OFFSET, crc, true);

    // Filename
    let startID = rows[0].querySelectorAll('input')[0].value;
    let endID = rows[rows.length-1].querySelectorAll('input')[0].value;
    downloadBlob(new Blob([buffer]), generateRTEFilename(startID, endID));
    logAction("Exported RTE", "Flight Plan", "Success");
}

// --- RTE HELPERS ---
function readRTEString(bytes, offset, length) {
    let str = "";
    if (offset + length > bytes.length) return "";
    for (let i = 0; i < length; i++) {
        let c = bytes[offset + i];
        if (c === 0) break;
        if (c >= 32 && c <= 126) str += String.fromCharCode(c);
    }
    return str.trim();
}

function writeRTEString(view, offset, str, maxLength, forceNull) {
    let written = 0;
    for (let i = 0; i < str.length && i < maxLength; i++) {
        view.setUint8(offset + i, str.charCodeAt(i));
        written++;
    }
    while (written < maxLength) {
        view.setUint8(offset + written, 0x20); // Space Pad
        written++;
    }
    // Strict Force Null: Overwrite last byte
    if (forceNull) view.setUint8(offset + maxLength - 1, 0x00); 
}

function calculateRTECRC(bytes) {
    let crc = 0xFFFFFFFF;
    for (let i = 0; i < bytes.length; i++) {
        crc ^= bytes[i];
        for (let j = 0; j < 8; j++) crc = (crc >>> 1) ^ ((crc & 1) ? 0xEDB88320 : 0);
    }
    return (crc ^ 0xFFFFFFFF) >>> 0;
}

function generateRTEFilename(s, e) {
    const fmt = (id) => {
        id = id.toUpperCase().trim();
        if (id.length === 4 && id.startsWith('K') && /^[A-Z]+$/.test(id)) return id.substring(1);
        return id.substring(0, 3);
    };
    return `${fmt(s)}-${fmt(e)}0.RTE`;
}

function decodeBinary(buf) {
    const v = new DataView(buf), count = v.getUint32(0, true);
    if (count <= 0) return;
    const wps = [];
    for (let i = 0; i < count; i++) {
        let off = HEADER_SIZE + (i * RECORD_SIZE);
        let id = "", nm = "";
        for (let j = 0; j < 9; j++) { let c = v.getUint8(off + 24 + j); if (c !== 0) id += String.fromCharCode(c); }
        for (let j = 0; j < 23; j++) { let c = v.getUint8(off + 33 + j); if (c !== 0) nm += String.fromCharCode(c); }
        wps.push({ id: id.trim(), name: nm.trim(), lat: v.getFloat64(off + 72, true).toFixed(6), lon: v.getFloat64(off + 80, true).toFixed(6), elev: 0, brg: 0 });
        if (i > 0) { wps[i-1].elev = v.getUint32(off + 0, true); wps[i-1].brg = v.getUint16(off + 16, true); }
    }
    populateTable(wps);
}

function checkAndExportGenesys() {
    const rows = [...tbody.querySelectorAll('tr')], headerHex = "9a01000000000000000000002000000000000000002000000000000000000000000000000000000000000000000000000a00000000000004728a3b76555424027eadf08657853c0";
    let bytes = [];
    let hBuf = new ArrayBuffer(HEADER_SIZE), hView = new DataView(hBuf);
    hView.setUint32(0, rows.length, true);
    for(let k=0; k<HEADER_SIZE; k++) bytes.push(k<4 ? hView.getUint8(k) : parseInt(headerHex.substr(k*2,2), 16));
    rows.forEach((r, i) => {
        const inp = r.querySelectorAll('input'), id = inp[0].value.toUpperCase(), nm = inp[1].value.toUpperCase();
        const lat = parseCoordinate(inp[2].value), lon = parseCoordinate(inp[3].value);
        let elev = 0, brg = 0;
        if (i > 0) { const pInp = rows[i-1].querySelectorAll('input'); elev = parseInt(pInp[4].value) || 0; brg = parseInt(pInp[5].value) || 0; }
        let buf = new ArrayBuffer(RECORD_SIZE), view = new DataView(buf);
        view.setUint32(0, elev, true); view.setUint16(16, brg, true);
        for(let j=0; j<9; j++) view.setUint8(24+j, (j<id.length)?id.charCodeAt(j):0);
        for(let j=0; j<23; j++) view.setUint8(33+j, (j<nm.length)?nm.charCodeAt(j):0);
        view.setUint8(64, 0x0A); view.setFloat64(72, lat, true); view.setFloat64(80, lon, true);
        for(let k=0; k<RECORD_SIZE; k++) bytes.push(view.getUint8(k));
    });
    while(bytes.length < TARGET_FILE_SIZE - 8) bytes.push(0);
    let crc = 0xFFFFFFFF; const table = makeCRCTable();
    for(let i=0; i<bytes.length; i++) crc = (crc >>> 8) ^ table[(crc ^ bytes[i]) & 0xFF];
    crc = (crc ^ 0xFFFFFFFF) >>> 0;
    let cBuf = new ArrayBuffer(4), cView = new DataView(cBuf);
    cView.setUint32(0, crc, true);
    for(let k=0; k<4; k++) bytes.push(cView.getUint8(k));
    bytes.push(0,0,0,0);
    downloadBlob(new Blob([new Uint8Array(bytes)]), "user.dat");
}

function makeCRCTable(){let c, t=[];for(let n=0;n<256;n++){c=n;for(let k=0;k<8;k++)c=((c&1)?(0xEDB88320^(c>>>1)):(c>>>1));t[n]=c;}return t;}

function exportCompleteFlight() {
    let csv = "ID,NAME,LAT,LON,ELEV,BRG\n";
    tbody.querySelectorAll('tr').forEach(r => { const i = r.querySelectorAll('input'); csv += `${i[0].value},${i[1].value},${parseCoordinate(i[2].value)},${parseCoordinate(i[3].value)},${i[4].value},${i[5].value}\n`; });
    downloadBlob(new Blob([csv], {type:'text/csv'}), "complete_flight.csv");
}

function exportKML() {
    let kml = `<?xml version="1.0" encoding="UTF-8"?><kml xmlns="http://www.opengis.net/kml/2.2"><Document><name>Waypoints</name>`;
    tbody.querySelectorAll('tr').forEach(r => { const i = r.querySelectorAll('input'); kml += `<Placemark><name>${i[0].value}</name><description>${i[1].value}</description><Point><coordinates>${parseCoordinate(i[3].value)},${parseCoordinate(i[2].value)},${i[4].value}</coordinates></Point></Placemark>`; });
    kml += `</Document></kml>`;
    downloadBlob(new Blob([kml], {type:'application/vnd.google-earth.kml+xml'}), "waypoints.kml");
}

function showMap() {
    document.getElementById('mapOverlay').style.display = 'block';
    if (!leafletMap) {
        leafletMap = L.map('map').setView([39.8283, -98.5795], 4);
        const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {attribution: 'OSM'}), sat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {attribution: 'Esri'}), sec = L.tileLayer('https://tiles.arcgis.com/tiles/ssFJjBXIUyZDrSYZ/arcgis/rest/services/VFR_Sectional/MapServer/tile/{z}/{y}/{x}', {attribution: 'FAA'});
        osm.addTo(leafletMap); L.control.layers({ "Street Map": osm, "Satellite": sat, "VFR Sectional": sec }).addTo(leafletMap);
    }
    if (markerLayer) leafletMap.removeLayer(markerLayer);
    markerLayer = L.layerGroup().addTo(leafletMap);
    let bounds = [];
    tbody.querySelectorAll('tr').forEach(r => {
        const i = r.querySelectorAll('input');
        if (i.length >= 4) {
            const lat = parseCoordinate(i[2].value), lon = parseCoordinate(i[3].value);
            if(!isNaN(lat) && !isNaN(lon)) { L.marker([lat, lon]).addTo(markerLayer).bindPopup(`<b>${i[0].value}</b><br>${i[1].value}`); bounds.push([lat, lon]); }
        }
    });
    if(bounds.length) leafletMap.fitBounds(bounds);
    setTimeout(() => leafletMap.invalidateSize(), 200);
}

function parseKML(xmlStr) {
    const parser = new DOMParser(), xml = parser.parseFromString(xmlStr, "text/xml"), pms = xml.getElementsByTagName("Placemark"), wps = [];
    for (let i = 0; i < pms.length; i++) {
        const pm = pms[i], id = pm.getElementsByTagName("name")[0]?.textContent || "", coord = pm.getElementsByTagName("coordinates")[0]?.textContent.trim().split(",");
        if (coord) wps.push({ id: id.substring(0,5), name: id, lat: parseFloat(coord[1]), lon: parseFloat(coord[0]), elev: 0, brg: 0 });
    }
    populateTable(wps);
}

function parseCoordinate(i) {
    if (!i) return 0;
    let str = i.toString().trim().toUpperCase(), mult = (/[SW-]/.test(str)) ? -1 : 1, parts = str.replace(/[NSWE°'"\-]/g, ' ').trim().split(/\s+/).filter(p => p.length > 0), dd = 0;
    if (parts.length === 1) dd = parseFloat(parts[0]);
    else if (parts.length === 2) dd = parseFloat(parts[0]) + (parseFloat(parts[1]) / 60);
    else if (parts.length >= 3) dd = parseFloat(parts[0]) + (parseFloat(parts[1]) / 60) + (parseFloat(parts[2]) / 3600);
    return (dd * mult).toFixed(6);
}

function populateTable(wps) {
    tbody.innerHTML = '';
    const frag = document.createDocumentFragment();
    wps.forEach(wp => { const row = document.createElement('tr'); createRowCells(row, wp); frag.appendChild(row); });
    tbody.appendChild(frag);
    updateColumnVisibility();
}

function createRowCells(r, wp) {
    r.draggable = true;
    r.addEventListener('dragstart', (e) => {
        draggedRow = r;
        const ghost = document.getElementById('drag-ghost'); ghost.innerHTML = '';
        const cloneTable = document.createElement('table'), cloneRow = r.cloneNode(true), origInps = r.querySelectorAll('input'), cloneInps = cloneRow.querySelectorAll('input');
        origInps.forEach((inp, idx) => cloneInps[idx].value = inp.value);
        cloneTable.appendChild(cloneRow); ghost.appendChild(cloneTable); e.dataTransfer.setDragImage(ghost, 20, 20);
        setTimeout(() => r.classList.add('dragging'), 0);
    });
    r.addEventListener('dragend', () => { draggedRow = null; r.classList.remove('dragging'); tbody.querySelectorAll('tr').forEach(row => row.classList.remove('drag-over')); });
    r.addEventListener('dragover', (e) => { e.preventDefault(); if (r !== draggedRow) r.classList.add('drag-over'); });
    r.addEventListener('dragleave', () => r.classList.remove('drag-over'));
    r.addEventListener('drop', (e) => {
        e.preventDefault(); r.classList.remove('drag-over');
        if (r !== draggedRow) {
            const allRows = [...tbody.querySelectorAll('tr')];
            if (allRows.indexOf(draggedRow) < allRows.indexOf(r)) r.after(draggedRow);
            else r.before(draggedRow);
        }
    });

    const c0 = r.insertCell(0); c0.innerText = '⠿'; c0.className = 'drag-handle';
    [wp.id, wp.name, formatCoord(wp.lat, true), formatCoord(wp.lon, false), wp.elev || '0', wp.brg || '0'].forEach((v, i) => {
        const cell = r.insertCell(i+1);
        const input = document.createElement('input'); input.value = v; input.oninput = () => updateQuickLinks(r);
        cell.appendChild(input);
    });
    const lC = r.insertCell(7); lC.className = 'quick-links action-col'; updateQuickLinks(r);
}

function updateQuickLinks(r) {
    const i = r.querySelectorAll('input'); if(i.length < 4) return;
    const lat = parseCoordinate(i[2].value), lon = parseCoordinate(i[3].value), c = r.querySelector('.quick-links');
    if (!isNaN(lat) && !isNaN(lon)) c.innerHTML = `<a href="http://googleusercontent.com/maps.google.com/search?q=${lat},${lon}" target="_blank">Google Maps</a> <span class="separator">|</span> <a href="https://earth.google.com/web/search/${lat},${lon}" target="_blank">Google Earth</a> <span class="separator">|</span> <a href="https://plan.foreflight.com/map#${lon}/${lat}/14" target="_blank">ForeFlight Web</a>`;
    else c.innerHTML = '';
}

function updateColumnVisibility() { 
    const rowCount = tbody.querySelectorAll('tr').length;
    document.querySelectorAll('.action-col').forEach(c => c.style.display = rowCount > 0 ? 'table-cell' : 'none'); 
    document.getElementById('actionBar').style.display = rowCount > 0 ? 'flex' : 'none';
}

function downloadBlob(blob, name) { const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = name; a.click(); }
function toggleTheme() { document.body.setAttribute('data-theme', document.body.getAttribute('data-theme') === 'light' ? 'dark' : 'light'); }

function removeAll() { 
    if(confirm("Clear data?")) { 
        tbody.innerHTML = ''; document.getElementById('fileInput').value = ''; document.getElementById('bulkInput').value = ''; 
        resetCoordinateUI(); updateColumnVisibility(); logAction("Cleared", "None", "Ready"); 
    } 
}

function debouncePaste() { clearTimeout(pasteTimer); pasteTimer = setTimeout(() => { const b = document.getElementById('bulkInput').value.trim(); if (b) smartParse(b); }, 500); }
function addRows(n) { for (let j = 0; j < n; j++) { const r = document.createElement('tr'); createRowCells(r, { id:'', name:'', lat:'', lon:'', elev:'0', brg:'0' }); tbody.appendChild(r); } updateColumnVisibility(); }
function showHistory() { document.getElementById('historyModal').style.display = 'block'; }
function closeHistory() { document.getElementById('historyModal').style.display = 'none'; }
function hideMap() { document.getElementById('mapOverlay').style.display = 'none'; }
function hideContextMenu() {}
</script>
</body>
</html>