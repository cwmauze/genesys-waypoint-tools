<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Genesys Aerosystems IDU Waypoint Loader</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root {
            --bg: #18191a; --card: #242526; --text: #e4e6eb; --border: #3e4042;
            --primary: #478df5; --secondary: #3a3b3c; --danger: #fb6161;
            --success: #28a745; --garmin: #007cc3; --dispatch: #f39c12;
            --earth: #2d81ff; --link: #a3c7ff;
        }
        [data-theme="light"] {
            --bg: #f0f2f5; --card: #ffffff; --text: #1c1e21; --border: #dadde1;
            --primary: #1a73e8; --secondary: #e4e6eb; --danger: #fa3e3e;
            --link: #1a73e8;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 20px; background: var(--bg); color: var(--text); transition: background 0.3s; }
        .container { max-width: 1500px; margin: auto; background: var(--card); padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); position: relative; }
        .version-subtitle { font-size: 11px; color: #90949c; margin-top: 4px; display: inline-block; font-weight: normal; cursor: pointer; text-decoration: underline; }
        .contact-link { font-size: 11px; color: #90949c; margin-left: 15px; text-decoration: underline; }
        .header-row { display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 2px solid var(--border); padding-bottom: 10px; margin-bottom: 20px; }
        h2 { margin: 0; color: var(--primary); line-height: 1; }
        
        .top-info-grid { display: grid; grid-template-columns: 1.5fr 1fr; gap: 20px; margin-bottom: 20px; }
        .instructions { background: rgba(71, 141, 245, 0.1); padding: 15px; border-radius: 8px; border-left: 5px solid var(--primary); font-size: 14px; line-height: 1.5; height: 100%; box-sizing: border-box; }
        .session-status-card { background: var(--secondary); padding: 15px; border-radius: 8px; border: 1px solid var(--border); font-size: 12px; height: 100%; box-sizing: border-box; }
        
        .action-bar { 
            background: var(--card) !important;
            padding: 15px; border-radius: 8px; margin-bottom: 20px; 
            display: flex; flex-wrap: wrap; gap: 10px; align-items: center;
            position: sticky; top: 0; z-index: 1002; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            border-bottom: 3px solid var(--primary);
        }

        table { width: 100%; border-collapse: collapse; margin: 20px 0; font-size: 12px; table-layout: fixed; }
        th, td { border: 1px solid var(--border); padding: 8px; text-align: left; vertical-align: middle; }
        
        thead th { 
            background-color: var(--secondary) !important;
            font-weight: 600; font-size: 11px; vertical-align: top; 
            user-select: none; line-height: 1.2; 
            position: sticky; 
            z-index: 1001; 
        }

        .action-col { display: none; }
        input { width: 95%; padding: 6px; border: 1px solid var(--border); border-radius: 4px; font-size: 12px; background: var(--card); color: var(--text); box-sizing: border-box; }
        .btn { padding: 10px 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; margin-right: 5px; margin-bottom: 5px; transition: all 0.2s ease; text-align: center; color: white; display: inline-block; vertical-align: middle; }
        .btn:hover { filter: brightness(1.2); transform: translateY(-1px); }
        .btn span { display: block; font-size: 10px; font-weight: 400; opacity: 0.9; margin-top: 2px; }
        .btn-secondary { background: var(--secondary); color: var(--text); }
        .btn-danger { background: var(--danger); }
        a { color: var(--link); text-decoration: none; font-weight: 500; font-size: 10px; }
        .separator { margin: 0 8px; color: #888; font-weight: bold; pointer-events: none; }
        
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); }
        .modal-content { background: var(--card); margin: 5% auto; padding: 25px; border: 1px solid var(--border); width: 60%; border-radius: 12px; color: var(--text); max-height: 80vh; display: flex; flex-direction: column; }
        .modal-body { overflow-y: auto; font-size: 13px; line-height: 1.6; padding-right: 10px; flex-grow: 1; }
        
        #mapOverlay { display: none; position: fixed; top: 5%; left: 5%; width: 90%; height: 80%; background: var(--card); z-index: 3000; border: 2px solid var(--primary); border-radius: 12px; }
        #map { width: 100%; height: calc(100% - 60px); }
    </style>
</head>
<body onload="startClock(); initStickyObserver();" onclick="hideContextMenu()">

<div class="container">
    <div class="header-row">
        <div>
            <h2>Genesys Aerosystems IDU Waypoint Loader</h2>
            <span class="version-subtitle" onclick="showHistory()">Build v7.4.1 (View History)</span>
            <a href="mailto:cistern_fob3m@icloud.com?subject=IDU%20Tool%20Feedback" class="contact-link">Contact / Feedback</a>
        </div>
        <button class="btn btn-secondary" onclick="toggleTheme()" id="themeBtn">☀️ Light Mode</button>
    </div>
    
    <div class="top-info-grid">
        <div class="instructions">
            <strong>Pre-Flight Data Prep:</strong><br>
            1. Select a file (<strong>Genesys user.dat</strong>, <strong>Garmin user.wpt</strong>, <strong>.csv</strong>, <strong>.kml</strong>) OR paste bulk data from spreadsheet software. The table will populate automatically.<br>
            2. Parser normalizes: <strong>DD</strong> (35.1234), <strong>DDM</strong> (35° 07.40' N), <strong>DMS</strong> (35° 07' 24" N).<br>
            3. Verify the table and export.
            <div style="font-size: 11px; margin-top: 8px;">
                <strong>References:</strong> 
                <a href="https://www.moog.com/products/avionics/aircraft-avionics/pilot-guides.html" target="_blank">Genesys IDU Guides</a> | 
                <a href="https://support.garmin.com/en-US/?faq=3mcdU37gXi88ipwjJIxJo7" target="_blank">Garmin GTN Guide</a>
            </div>
        </div>

        <div class="session-status-card">
            <div style="font-weight: bold; color: var(--primary); margin-bottom: 10px; text-transform: uppercase; font-size: 10px; display: flex; justify-content: space-between;">
                <span>Session status</span>
                <span id="local-clock" style="color: var(--text);">00:00:00</span>
            </div>
            <div style="margin-bottom:6px; display:flex; justify-content:space-between;"><span>Last Action:</span> <span id="last-action">Ready</span></div>
            <div style="margin-bottom:6px; display:flex; justify-content:space-between;"><span>Current Total:</span> <span id="wp-count-display">0</span></div>
            <div style="display:flex; justify-content:space-between;"><span>System Status:</span> <span id="sys-status" class="status-ready">● Ready</span></div>
        </div>
    </div>

    <div style="display: flex; gap: 20px; margin-bottom: 20px;">
        <div style="flex: 1;"><label style="font-size: 13px; font-weight: 600;">Option A: Load File</label><input type="file" id="fileInput" accept=".dat,.csv,.txt,.kml,.wpt,.xml" onchange="processFile()"></div>
        <div style="flex: 2;"><label style="font-size: 13px; font-weight: 600;">Option B: Bulk Paste</label><textarea id="bulkInput" style="width:100%; height:42px; border-radius:6px; border:1px solid var(--border); background:var(--card); color:var(--text); padding: 5px;" placeholder="Paste coordinates here..." oninput="debouncePaste()"></textarea></div>
    </div>

    <div class="action-bar" id="actionBar">
        <span style="font-size: 12px; font-weight: bold; color: var(--primary); margin-right: 10px;">EXPORT:</span>
        <button class="btn" onclick="validateAndExportGenesys()" style="background-color: var(--success);">Download user.dat <span>GENESYS IDU</span></button>
        <button class="btn" onclick="validateAndExportGarmin()" style="background-color: var(--garmin);">Download user.wpt <span>GARMIN GNS / GTN</span></button>
        <button class="btn" onclick="exportCompleteFlight()" style="background-color: var(--dispatch);">Download CSV <span>COMPLETE FLIGHT</span></button>
        <button class="btn" onclick="showMap()" style="background-color: var(--earth);">Preview on Map <span>STREET / SAT / SECTIONAL</span></button>
        <button class="btn btn-secondary" onclick="exportKML()" style="background-color: #6f42c1; color: white;">Export KML <span>GOOGLE EARTH</span></button>
        <div style="flex-grow: 1;"></div>
        <button class="btn btn-danger" onclick="removeAll()">CLEAR ALL DATA</button>
    </div>
    
    <table id="wpTable">
        <thead id="tableHeader">
            <tr>
                <th style="width: 3%;"></th>
                <th style="width: 10%;">Identifier</th>
                <th style="width: 14%;">Name</th>
                <th style="width: 12%;">Latitude</th>
                <th style="width: 12%;">Longitude</th>
                <th style="width: 10%;">Elevation<br>(Ft. MSL)</th>
                <th style="width: 12%;">Approach Bearing<br>(Genesys)</th>
                <th style="width: 27%;" class="action-col">View waypoint in</th>
            </tr>
        </thead>
        <tbody id="table-body"></tbody>
    </table>

    <div style="display: flex; gap: 10px; margin-top: 10px;">
        <button class="btn btn-secondary" onclick="addRows(1)">+ Add 1 Row</button>
        <button class="btn btn-secondary" onclick="addRows(5)">+ Add 5 Rows</button>
        <button class="btn btn-secondary" onclick="addRows(10)">+ Add 10 Rows</button>
    </div>

    <div class="footer" style="margin-top: 40px; font-size: 11px; color: #90949c; text-align: center; border-top: 1px solid var(--border); padding-top: 20px;">
        <a href="https://github.com/cwmauze/genesys-waypoint-tools/tree/main" target="_blank">Open Source Project Home</a>
    </div>

    <div id="historyModal" class="modal">
        <div class="modal-content">
            <h3 style="margin-top:0; border-bottom: 1px solid var(--border); padding-bottom: 10px;">Project Version History</h3>
            <div class="modal-body" id="modal-body">
                <strong>v7.4.1:</strong> Hardened KML import to handle whitespace; Updated contact info.<br>
                <strong>v7.4:</strong> Robust KML parser; Validation updates (Genesys 12-char / Garmin 25-char limits).<br>
                <strong>v7.3:</strong> Updated validation logic for cockpit display constraints.<br>
                <strong>v7.2:</strong> Restored pre-flight warnings for capacity and identifier length.<br>
                <strong>v7.1.6:</strong> Fixed VFR Sectional provider (Switched to FAA ArcGIS).<br>
                <strong>v7.1 Stable:</strong> Core logic synchronized with Shift/CRC/64-bit engine.<br>
                <strong>v6.00:</strong> Complete UI overhaul with Action Bar and Sticky Headers.<br>
                <strong>v5.00:</strong> Initial release of reverse-engineered binary export.
            </div>
            <button class="btn btn-secondary" style="margin-top:20px" onclick="closeHistory()">Close</button>
        </div>
    </div>

    <div id="mapOverlay">
        <div id="map"></div>
        <div style="padding: 10px; background: var(--secondary); text-align: right;"><button class="btn btn-danger" onclick="hideMap()">Close Map</button></div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const RECORD_SIZE = 88, HEADER_SIZE = 72, TARGET_FILE_SIZE = 88016;
let leafletMap = null, markerLayer = null, pasteTimer;
const tbody = document.getElementById('table-body');

function initStickyObserver() {
    const actionBar = document.getElementById('actionBar');
    const headerCells = document.querySelectorAll('#tableHeader th');
    const observer = new ResizeObserver(entries => {
        for (let entry of entries) {
            const height = entry.borderBoxSize[0].blockSize - 2; 
            headerCells.forEach(th => th.style.top = height + 'px');
        }
    });
    observer.observe(actionBar);
}

function startClock() { setInterval(() => { document.getElementById('local-clock').innerText = new Date().toLocaleTimeString('en-GB', { hour12: false }); }, 1000); }
function logAction(action, source, statusText) { 
    document.getElementById('last-action').innerText = action + " (" + new Date().toLocaleTimeString('en-GB', { hour12: false }) + ")"; 
    document.getElementById('wp-count-display').innerText = tbody.querySelectorAll('tr').length; 
    if(statusText) document.getElementById('sys-status').innerText = "● " + statusText;
}

function processFile() {
    const f = document.getElementById('fileInput');
    if (f.files.length > 0) {
        const file = f.files[0], reader = new FileReader(), ext = file.name.toLowerCase().split('.').pop();
        reader.onload = e => {
            if (ext === 'dat') decodeBinary(e.target.result);
            else if (ext === 'kml' || ext === 'xml') parseKML(e.target.result);
            else parseText(e.target.result);
            logAction("File Loaded", file.name, "Success");
        };
        ext === 'dat' ? reader.readAsArrayBuffer(file) : reader.readAsText(file);
    }
}

// v7.1 IMPORT
function decodeBinary(buf) {
    const v = new DataView(buf);
    const count = v.getUint32(0, true);
    const actualRecords = Math.floor((buf.byteLength - HEADER_SIZE) / RECORD_SIZE);
    
    if (count <= 0 || actualRecords <= 0) { alert("File appears empty or invalid."); return; }

    const wps = [];
    
    for (let i = 0; i < count; i++) {
        let off = HEADER_SIZE + (i * RECORD_SIZE);
        let id = "";
        for (let j = 0; j < 9; j++) { let c = v.getUint8(off + 24 + j); if (c !== 0) id += String.fromCharCode(c); }
        let nm = "";
        for (let j = 0; j < 23; j++) { let c = v.getUint8(off + 33 + j); if (c !== 0) nm += String.fromCharCode(c); }
        
        wps.push({ 
            id: id.trim(), name: nm.trim(), 
            lat: v.getFloat64(off + 72, true).toFixed(6), 
            lon: v.getFloat64(off + 80, true).toFixed(6), 
            elev: 0, brg: 0 
        });
        
        if (i > 0) {
            wps[i-1].elev = v.getUint32(off + 0, true);
            wps[i-1].brg = v.getUint16(off + 16, true);
        }
    }
    
    if (actualRecords > count && wps.length > 0) {
        let off = HEADER_SIZE + (count * RECORD_SIZE);
        wps[wps.length - 1].elev = v.getUint32(off + 0, true);
        wps[wps.length - 1].brg = v.getUint16(off + 16, true);
    }
    
    populateTable(wps);
}

// v7.4 GENESYS Validation (12 Char Limit)
function validateAndExportGenesys() {
    const rows = tbody.querySelectorAll('tr');
    const MAX_CAPACITY = 998;
    const MAX_ID_LEN = 5;
    const MAX_NAME_LEN = 12; // Genesys Display Limit
    
    if (rows.length > MAX_CAPACITY) {
        alert(`Capacity Warning:\nThis list contains ${rows.length} waypoints.\nThe IDU system can only reliably load ${MAX_CAPACITY}.`);
    }

    let longIds = [], longNames = [];
    rows.forEach(r => {
        const inp = r.querySelectorAll('input');
        const id = inp[0].value.trim();
        const name = inp[1].value.trim();
        if (id.length > MAX_ID_LEN) longIds.push(id);
        if (name.length > MAX_NAME_LEN) longNames.push(name);
    });

    let msg = "";
    if (longIds.length > 0) msg += `Identifier Warning (Genesys):\n${longIds.length} identifiers exceed 5 chars and will be truncated.\n(e.g. ${longIds.slice(0,3).join(", ")}...)\n\n`;
    if (longNames.length > 0) msg += `Name Warning (Genesys):\n${longNames.length} names exceed 12 chars (cockpit display limit).\n(e.g. ${longNames.slice(0,3).join(", ")}...)\n\n`;

    if (msg !== "" && !confirm(msg + "Proceed with export?")) return;
    checkAndExportGenesys();
}

// v7.4 GARMIN Validation (25 Char Limit)
function validateAndExportGarmin() {
    const rows = tbody.querySelectorAll('tr');
    const MAX_NAME_LEN = 25; // Garmin GTN Limit
    
    let longNames = [];
    rows.forEach(r => {
        const inp = r.querySelectorAll('input');
        const name = inp[1].value.trim();
        if (name.length > MAX_NAME_LEN) longNames.push(name);
    });

    if (longNames.length > 0) {
        let msg = `Name Warning (Garmin):\n${longNames.length} names exceed 25 chars.\n(e.g. ${longNames.slice(0,3).join(", ")}...)\n\nProceed?`;
        if (!confirm(msg)) return;
    }
    checkAndExportGarmin();
}

// v7.1 EXPORT Core (Genesys)
function checkAndExportGenesys() {
    const rows = [...tbody.querySelectorAll('tr')];
    const headerHex = "9a01000000000000000000002000000000000000002000000000000000000000000000000000000000000000000000000a000000000000004728a3b76555424027eadf08657853c0";
    
    let bytes = [];
    let hBuf = new ArrayBuffer(HEADER_SIZE);
    let hView = new DataView(hBuf);
    hView.setUint32(0, rows.length, true);
    for(let k=0; k<HEADER_SIZE; k++) {
        if(k<4) bytes.push(hView.getUint8(k));
        else bytes.push(parseInt(headerHex.substr(k*2,2), 16));
    }
    
    rows.forEach((r, i) => {
        const inp = r.querySelectorAll('input');
        const id = inp[0].value.toUpperCase();
        const nm = inp[1].value.toUpperCase();
        const lat = parseFloat(inp[2].value);
        const lon = parseFloat(inp[3].value);
        
        let elev = 0, brg = 0;
        if (i > 0) {
            const prevInp = rows[i-1].querySelectorAll('input');
            elev = parseInt(prevInp[4].value) || 0;
            brg = parseInt(prevInp[5].value) || 0;
        }
        
        let buf = new ArrayBuffer(RECORD_SIZE);
        let view = new DataView(buf);
        view.setUint32(0, elev, true);
        view.setUint16(16, brg, true);
        
        for(let j=0; j<9; j++) view.setUint8(24+j, (j<id.length)?id.charCodeAt(j):0);
        for(let j=0; j<23; j++) view.setUint8(33+j, (j<nm.length)?nm.charCodeAt(j):0);
        
        view.setUint8(64, 0x0A);
        view.setFloat64(72, lat, true);
        view.setFloat64(80, lon, true);
        
        for(let k=0; k<RECORD_SIZE; k++) bytes.push(view.getUint8(k));
    });
    
    if (rows.length > 0) {
        const lastInp = rows[rows.length-1].querySelectorAll('input');
        let lElev = parseInt(lastInp[4].value) || 0;
        let lBrg = parseInt(lastInp[5].value) || 0;
        let dBuf = new ArrayBuffer(RECORD_SIZE);
        let dView = new DataView(dBuf);
        dView.setUint32(0, lElev, true);
        dView.setUint16(16, lBrg, true);
        dView.setUint8(64, 0x0A);
        for(let k=0; k<RECORD_SIZE; k++) bytes.push(dView.getUint8(k));
    }
    
    while(bytes.length < TARGET_FILE_SIZE - 8) bytes.push(0);
    
    let crc = 0xFFFFFFFF;
    const table = makeCRCTable();
    for(let i=0; i<bytes.length; i++) crc = (crc >>> 8) ^ table[(crc ^ bytes[i]) & 0xFF];
    crc = (crc ^ 0xFFFFFFFF) >>> 0;
    
    let cBuf = new ArrayBuffer(4);
    let cView = new DataView(cBuf);
    cView.setUint32(0, crc, true);
    for(let k=0; k<4; k++) bytes.push(cView.getUint8(k));
    bytes.push(0,0,0,0);
    
    downloadBlob(new Blob([new Uint8Array(bytes)]), "user.dat");
}

function makeCRCTable(){let c;let t=[];for(let n=0;n<256;n++){c=n;for(let k=0;k<8;k++)c=((c&1)?(0xEDB88320^(c>>>1)):(c>>>1));t[n]=c;}return t;}

// Garmin Export
function checkAndExportGarmin() {
    let csv = "Identifier,Name,Latitude,Longitude,Elevation,Comment\n";
    tbody.querySelectorAll('tr').forEach(r => {
        const i = r.querySelectorAll('input');
        csv += `${i[0].value},${i[1].value},${i[2].value},${i[3].value},${i[4].value},Garmin GTN\n`;
    });
    downloadBlob(new Blob([csv], {type:'text/csv'}), "user.wpt");
}

// Complete Flight CSV
function exportCompleteFlight() {
    let csv = "ID,NAME,LAT,LON,ELEV,BRG\n";
    tbody.querySelectorAll('tr').forEach(r => {
        const i = r.querySelectorAll('input');
        csv += `${i[0].value},${i[1].value},${i[2].value},${i[3].value},${i[4].value},${i[5].value}\n`;
    });
    downloadBlob(new Blob([csv], {type:'text/csv'}), "complete_flight.csv");
}

// KML Export
function exportKML() {
    let kml = `<?xml version="1.0" encoding="UTF-8"?><kml xmlns="http://www.opengis.net/kml/2.2"><Document><name>Genesys Waypoints</name>`;
    tbody.querySelectorAll('tr').forEach(r => {
        const i = r.querySelectorAll('input');
        kml += `<Placemark><name>${i[0].value}</name><description>${i[1].value}</description><Point><coordinates>${i[3].value},${i[2].value},${i[4].value}</coordinates></Point></Placemark>`;
    });
    kml += `</Document></kml>`;
    downloadBlob(new Blob([kml], {type:'application/vnd.google-earth.kml+xml'}), "waypoints.kml");
}

// Map Logic (v7.1.6)
function showMap() {
    document.getElementById('mapOverlay').style.display = 'block';
    if (!leafletMap) {
        leafletMap = L.map('map').setView([39.8283, -98.5795], 4);
        const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {attribution: 'OSM'});
        const sat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {attribution: 'Esri'});
        const sec = L.tileLayer('https://tiles.arcgis.com/tiles/ssFJjBXIUyZDrSYZ/arcgis/rest/services/VFR_Sectional/MapServer/tile/{z}/{y}/{x}', {attribution: 'FAA'});
        osm.addTo(leafletMap);
        L.control.layers({ "Street Map": osm, "Satellite": sat, "VFR Sectional": sec }).addTo(leafletMap);
    }
    if (markerLayer) leafletMap.removeLayer(markerLayer);
    markerLayer = L.layerGroup().addTo(leafletMap);
    let bounds = [];
    tbody.querySelectorAll('tr').forEach(r => {
        const i = r.querySelectorAll('input');
        const lat = parseFloat(i[2].value), lon = parseFloat(i[3].value);
        if(!isNaN(lat) && !isNaN(lon)) {
            L.marker([lat, lon]).addTo(markerLayer).bindPopup(`<b>${i[0].value}</b><br>${i[1].value}`);
            bounds.push([lat, lon]);
        }
    });
    if(bounds.length) leafletMap.fitBounds(bounds);
    setTimeout(() => leafletMap.invalidateSize(), 200);
}

function parseText(t) {
    const lines = t.split(/\r?\n/), wps = [];
    lines.forEach(l => {
        const c = l.split(/[,\t]/).map(col => col.trim().replace(/"/g, ''));
        if (!c[0] || isNaN(parseFloat(c[2]))) return;
        wps.push({ id: c[0], name: c[1] || "", lat: parseCoordinate(c[2]), lon: parseCoordinate(c[3]), elev: c[4] || 0, brg: c[5] || 0 });
    });
    populateTable(wps);
}

// v7.4.1 KML Parser (Hardened)
function parseKML(xmlStr) {
    try {
        const parser = new DOMParser();
        const xml = parser.parseFromString(xmlStr, "text/xml");
        const placemarks = xml.getElementsByTagName("Placemark");
        if (placemarks.length === 0) { alert("No waypoints found in KML file."); return; }
        
        const wps = [];
        for (let i = 0; i < placemarks.length; i++) {
            const pm = placemarks[i];
            
            // Name Parsing
            let name = "";
            const nameTag = pm.getElementsByTagName("name")[0];
            if (nameTag) name = nameTag.textContent.trim();
            
            // Description Parsing
            let desc = "";
            const descTag = pm.getElementsByTagName("description")[0];
            if (descTag) desc = descTag.textContent.trim();
            
            // Coordinate Parsing (Deep search for Point->coordinates)
            const point = pm.getElementsByTagName("Point")[0];
            if (point) {
                const coordTag = point.getElementsByTagName("coordinates")[0];
                if (coordTag) {
                    // Aggressive cleanup of KML whitespace/newlines
                    const rawCoords = coordTag.textContent.replace(/\s+/g, '').trim(); 
                    const parts = rawCoords.split(",");
                    if (parts.length >= 2) {
                        wps.push({
                            id: name.substring(0,5), 
                            name: (desc || name).substring(0,25),
                            lat: parseFloat(parts[1]).toFixed(6),
                            lon: parseFloat(parts[0]).toFixed(6),
                            elev: parts[2] ? Math.round(parseFloat(parts[2])) : 0,
                            brg: 0
                        });
                    }
                }
            }
        }
        populateTable(wps);
        logAction("Imported " + wps.length + " KML waypoints", "KML", "Success");
    } catch(e) { alert("KML Parsing Error: " + e.message); }
}

function parseCoordinate(i) {
    if (!i) return 0; let str = i.toString().trim().toUpperCase(), mult = (/[SW-]/.test(str)) ? -1 : 1;
    let parts = str.replace(/[^0-9. ]/g, ' ').trim().split(/\s+/).filter(p => p.length > 0), dd = 0;
    if (parts.length === 1) dd = parseFloat(parts[0]);
    else if (parts.length === 2) dd = parseFloat(parts[0]) + (parseFloat(parts[1]) / 60);
    else if (parts.length >= 3) dd = parseFloat(parts[0]) + (parseFloat(parts[1]) / 60) + (parseFloat(parts[2]) / 3600);
    return (dd * mult).toFixed(6);
}

function populateTable(wps) {
    tbody.innerHTML = '';
    const frag = document.createDocumentFragment();
    wps.forEach(wp => {
        const row = document.createElement('tr');
        createRowCells(row, wp);
        frag.appendChild(row);
    });
    tbody.appendChild(frag);
    updateColumnVisibility();
}

function createRowCells(r, wp) {
    const c0 = r.insertCell(0); c0.innerText = '⠿';
    [wp.id, wp.name, wp.lat, wp.lon, wp.elev || '0', wp.brg || '0'].forEach((v, i) => {
        const cell = r.insertCell(i+1);
        const input = document.createElement('input'); 
        input.value = v;
        input.oninput = () => updateQuickLinks(r);
        cell.appendChild(input);
    });
    const linkCell = r.insertCell(7);
    linkCell.className = 'quick-links action-col'; 
    updateQuickLinks(r);
}

function updateQuickLinks(r) {
    const i = r.querySelectorAll('input');
    if(i.length < 4) return;
    const lat = parseFloat(i[2].value), lon = parseFloat(i[3].value), c = r.querySelector('.quick-links');
    if (!isNaN(lat) && !isNaN(lon)) {
        c.innerHTML = `<a href="http://googleusercontent.com/maps.google.com/search?q=${lat},${lon}" target="_blank">Google Maps</a> <span class="separator">|</span> <a href="https://earth.google.com/web/search/${lat},${lon}" target="_blank">Google Earth</a> <span class="separator">|</span> <a href="https://plan.foreflight.com/map#${lon}/${lat}/14" target="_blank">ForeFlight Web</a>`;
    } else c.innerHTML = '';
}

function updateColumnVisibility() { document.querySelectorAll('.action-col').forEach(c => c.style.display = tbody.querySelectorAll('tr').length > 0 ? 'table-cell' : 'none'); }
function downloadBlob(blob, name) { const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = name; a.click(); }
function toggleTheme() { document.body.setAttribute('data-theme', document.body.getAttribute('data-theme') === 'light' ? 'dark' : 'light'); }
function removeAll() { if(confirm("Clear data?")) { tbody.innerHTML = ''; document.getElementById('fileInput').value = ''; updateColumnVisibility(); logAction("Cleared", "None", "Ready"); } }
function debouncePaste() { clearTimeout(pasteTimer); pasteTimer = setTimeout(() => { const b = document.getElementById('bulkInput').value.trim(); if (b) parseText(b); }, 500); }
function addRows(n) { const frag = document.createDocumentFragment(); for (let j = 0; j < n; j++) { const r = document.createElement('tr'); createRowCells(r, { id:'', name:'', lat:'', lon:'', elev:'0', brg:'0' }); frag.appendChild(r); } tbody.appendChild(frag); updateColumnVisibility(); }
function showHistory() { document.getElementById('historyModal').style.display = 'block'; }
function closeHistory() { document.getElementById('historyModal').style.display = 'none'; }
function hideMap() { document.getElementById('mapOverlay').style.display = 'none'; }
function hideContextMenu() {}
</script>
</body>
</html>
