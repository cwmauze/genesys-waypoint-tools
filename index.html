<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Genesys IDU Waypoint and Route Tools</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        /* ---------------------------------------------------------
           SECTION: THEME & COLOR VARIABLES
           Defines the colors for Dark and Light modes.
           --------------------------------------------------------- */
        :root {
            --bg: #18191a; --card: #242526; --text: #e4e6eb; --border: #3e4042;
            --primary: #478df5; --secondary: #3a3b3c; --danger: #fb6161;
            --success: #28a745; --garmin: #007cc3; --dispatch: #f39c12;
            --earth: #2d81ff; --link: #a3c7ff; --foreflight: #007aff;
            --header-sep: rgba(255, 255, 255, 0.1);
        }
        [data-theme="light"] {
            --bg: #f0f2f5; --card: #ffffff; --text: #1c1e21; --border: #dadde1;
            --primary: #1a73e8; --secondary: #e4e6eb; --danger: #fa3e3e;
            --link: #1a73e8;
            --header-sep: rgba(0, 0, 0, 0.1);
        }

        /* ---------------------------------------------------------
           SECTION: CORE LAYOUT
           General spacing and typography for the application.
           --------------------------------------------------------- */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 20px; background: var(--bg); color: var(--text); transition: background 0.3s; }
        .container { max-width: 1500px; margin: auto; background: var(--card); padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); position: relative; }
        .version-subtitle { font-size: 11px; color: #90949c; margin-top: 4px; display: inline-block; font-weight: normal; cursor: pointer; text-decoration: underline; }
        .contact-link, .project-link { font-size: 11px; color: #90949c; margin-left: 15px; text-decoration: underline; }
        .header-row { display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 2px solid var(--border); padding-bottom: 10px; margin-bottom: 20px; }
        h2 { margin: 0; color: var(--primary); line-height: 1; }
        
        .top-info-grid { display: grid; grid-template-columns: 1.5fr 1fr; gap: 20px; margin-bottom: 20px; }
        .instructions { background: rgba(71, 141, 245, 0.1); padding: 15px; border-radius: 8px; border-left: 5px solid var(--primary); font-size: 14px; line-height: 1.5; height: 100%; box-sizing: border-box; }
        .session-status-card { background: var(--secondary); padding: 15px; border-radius: 8px; border: 1px solid var(--border); font-size: 12px; height: 100%; box-sizing: border-box; }
        
        .status-line { margin-bottom: 6px; display: flex; justify-content: space-between; align-items: center; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #555; display: inline-block; margin-left: 5px; }
        .status-dot.loading { background: var(--dispatch); animation: dbPulse 1s infinite; }
        .status-dot.ready { background: var(--success); }
        .status-dot.error { background: var(--danger); }
        .status-dot.danger-pulse { background: var(--danger); animation: errorPulse 0.8s infinite; }
        @keyframes errorPulse { 0% { box-shadow: 0 0 0 0px rgba(251, 97, 97, 0.7); } 100% { box-shadow: 0 0 0 8px rgba(251, 97, 97, 0); } }

        @keyframes dbPulse { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }

        /* ---------------------------------------------------------
           SECTION: ACTION BAR BUTTONS
           Styles for the row of export and map buttons.
           --------------------------------------------------------- */
        .action-bar { 
            background: var(--card) !important; padding: 15px; border-radius: 8px; margin-bottom: 20px; 
            display: none; flex-wrap: wrap; gap: 10px; align-items: center;
            position: sticky; top: 0; z-index: 1002; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.2); border-bottom: 3px solid var(--primary);
        }

        /* ---------------------------------------------------------
           SECTION: DATA TABLE & ROW STYLING
           Controls the look of the waypoint grid.
           --------------------------------------------------------- */
        table { width: 100%; border-collapse: collapse; margin: 20px 0; font-size: 12px; table-layout: fixed; border: 1px solid var(--border); }
        th, td { border: 1px solid var(--border); padding: 8px; text-align: left; vertical-align: middle; position: relative; }
        thead th { background-color: var(--secondary) !important; font-weight: 600; font-size: 11px; user-select: none; line-height: 1.2; position: sticky; z-index: 1001; padding-top: 6px; padding-bottom: 6px; border-right: 1px solid var(--header-sep); }
        .clickable-header { cursor: pointer; text-decoration: underline dotted; }
        .clickable-header:hover { background-color: var(--primary) !important; color: white; }

        input { width: 95%; padding: 6px; border: 1px solid var(--border); border-radius: 4px; font-size: 12px; background: var(--card); color: var(--text); box-sizing: border-box; }
        .btn { padding: 10px 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; margin-right: 5px; margin-bottom: 5px; transition: all 0.2s ease; text-align: center; color: white; display: inline-block; vertical-align: middle; }
        .btn span { display: block; font-size: 10px; font-weight: 400; opacity: 0.9; margin-top: 2px; }
        .btn-secondary { background: var(--secondary); color: var(--text); }
        .btn-danger { background: var(--danger); }
        a { color: var(--link); text-decoration: none; font-weight: 500; font-size: 10px; }
        .separator { margin: 0; color: #888; font-weight: bold; pointer-events: none; }
        
        /* ---------------------------------------------------------
           SECTION: ROW MANAGEMENT (Delete, Insert, Drag)
           Styles for the row control handles on the far left.
           --------------------------------------------------------- */
        .delete-btn { color: var(--danger); cursor: pointer; font-weight: bold; font-size: 14px; opacity: 0.4; transition: opacity 0.2s; text-align: center; user-select: none; }
        .delete-btn:hover { opacity: 1; }
        .insert-btn { color: var(--primary); cursor: pointer; font-weight: bold; font-size: 14px; opacity: 0.4; transition: opacity 0.2s; text-align: center; user-select: none; }
        .insert-btn:hover { opacity: 1; }
        .drag-handle { cursor: grab; text-align: center; color: var(--primary); font-size: 16px; user-select: none; opacity: 0.7; }
        tr.dragging { opacity: 0.2; }
        tr.drag-over { border-top: 3px solid var(--primary) !important; background: rgba(71, 141, 245, 0.05); }
        .row-number { text-align: center; font-family: monospace; opacity: 0.7; font-size: 11px; }

        /* ---------------------------------------------------------
           SECTION: MAP & OVERLAYS
           Leaflet map container and navigation data labels.
           --------------------------------------------------------- */
        #mapOverlay { display: none; position: fixed; top: 5%; left: 5%; width: 90%; height: 80%; background: var(--card); z-index: 3000; border: 2px solid var(--primary); border-radius: 12px; }
        #map { width: 100%; height: calc(100% - 60px); }

        .map-toggle-panel { position: absolute; top: 12px; right: 10px; z-index: 4001; background: var(--card); padding: 6px 10px; border-radius: 4px; border: 1px solid var(--border); font-size: 11px; display: flex; flex-direction: column; gap: 6px; box-shadow: 0 2px 5px rgba(0,0,0,0.5); color: var(--text); }
        .toggle-item { display: flex; align-items: center; gap: 6px; }
        .numbered-marker { background: var(--primary); border: 2px solid white; border-radius: 50%; color: white; font-weight: bold; text-align: center; line-height: 20px; font-size: 10px; }
        
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.75); z-index: 5999; }
        #versionHistory { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--card); border: 2px solid var(--primary); padding: 25px; border-radius: 12px; font-size: 12px; z-index: 6000; box-shadow: 0 10px 30px rgba(0,0,0,0.5); max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; color: var(--text); line-height: 1.6; }

        .file-upload-wrapper { position: relative; overflow: hidden; display: inline-block; width: 100%; }
        .file-upload-wrapper input[type="file"] { position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%; }
        .btn-upload { background: var(--secondary); color: var(--text); border: 1px solid var(--border); width: 100%; display: block; margin: 0; }
        .btn-upload:hover { background: var(--primary); color: white; }

        .autocomplete-list { position: absolute; top: 100%; left: 0; width: 100%; background: var(--secondary); border: 1px solid var(--primary); border-radius: 4px; z-index: 2000; box-shadow: 0 4px 8px rgba(0,0,0,0.3); max-height: 150px; overflow-y: auto; display: none; }
        .autocomplete-item { padding: 6px 10px; cursor: pointer; border-bottom: 1px solid var(--border); font-size: 11px; }
        .autocomplete-item:hover { background: var(--primary) !important; color: white; }

        .leg-label { background: rgba(0, 0, 0, 0.75); border: 1px solid var(--primary); color: white; padding: 2px 5px; border-radius: 3px; font-size: 10px; font-weight: bold; white-space: nowrap; }
    </style>
</head>

<body onload="startClock(); initStickyObserver(); initAviationDB(); loadSession();">

<div class="modal-overlay" id="historyOverlay" onclick="toggleVersionHistory()">
    <div id="versionHistory" onclick="event.stopPropagation()">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid var(--border); padding-bottom:10px;">
            <strong style="color:var(--primary); font-size:14px;">Rolling Version History</strong>
            <span style="cursor:pointer; font-size:18px; opacity:0.7;" onclick="toggleVersionHistory()">✕</span>
        </div>
        <b>v8.2.1.25</b> - Fixed "Insert Row" logic to insert ABOVE the target row.<br>
        <b>v8.2.1.24</b> - Added inline "Insert Row" handles and removed delete confirmation.<br>
        <b>v8.2.1.23</b> - Added "Delete Row" handle to the left side of table.<br>
        <b>v8.2.1.22</b> - Applied technical manual documentation layer.<br>
        <b>v8.2.1.20</b> - Added header rotation subtitles and updated KML button labeling.<br>
        <b>v8.2.1.19</b> - Improved FPL Exporter with database-aware waypoint typing.<br>
        <b>v8.2.1.18</b> - Integrated ForeFlight .fpl Export with FIRST-LAST naming convention.<br>
        <b>v8.2.1.17</b> - Fixed theme toggle logic and updated Moon icon to crescent.<br>
        <b>v8.2.1.16</b> - Added ForeFlight .fpl import support and Truth-First priority logic.
    </div>
</div>

<div class="container">
    <div class="header-row">
        <div>
            <h2>Genesys IDU Waypoint and Route Tools</h2>
            <span class="version-subtitle" onclick="toggleVersionHistory()">v8.2.1.25 Beta</span>
            <a href="mailto:cistern_fob3m@icloud.com" class="contact-link">Contact / Feedback</a>
            <a href="https://github.com/cwmauze/genesys-waypoint-tools" target="_blank" class="project-link">GitHub Project Home</a>
        </div>
        <button class="btn btn-secondary" onclick="toggleTheme()" id="themeBtn" style="font-size: 18px; padding: 6px 12px;">☀️</button>
    </div>

    <div style="font-size: 13px; color: #90949c; margin-bottom: 25px; line-height: 1.5; max-width: 1000px; border-left: 2px solid var(--border); padding-left: 15px;">
        This tool serves as a necessary interface for generating navigation database files, as Genesys Aerosystems does not provide a standalone utility for this process. It automates the extraction and validation of waypoint identifiers and coordinates from diverse sources into the specific binary structure required for Genesys and Garmin avionics uploads.
    </div>
    
    <div class="top-info-grid">
        <div class="instructions">
            <strong>Pre-Flight Data Prep:</strong><br>
            1. Select a file (<strong>Genesys DAT/RTE</strong>, <strong>ForeFlight FPL</strong>, <strong>Garmin WPT</strong>, <strong>CSV/KML</strong>) or paste data.<br>
            2. Parser normalizes: <strong>DD</strong> (35.1234), <strong>DDM</strong> (35° 07.40' N), <strong>DMS</strong> (35° 07' 24" N).<br>
            3. Verify the table and export.
            
            <div style="margin-top: 12px; padding-top: 8px; border-top: 1px solid rgba(71, 141, 245, 0.2); font-size: 11px;">
                <strong>Reference Manuals:</strong><br>
                <a href="https://www.moog.com/products/avionics/aircraft-avionics/pilot-guides.html" target="_blank" style="font-size: 11px;">Genesys IDU Pilot's Guides</a> 
                <span class="separator">|</span> 
                <a href="https://support.garmin.com/en-US/?faq=3mcdU37gXi88ipwjJIxJo7" target="_blank" style="font-size: 11px;">Garmin Waypoint Import Guide</a>
            </div>
        </div>

        <div class="session-status-card">
            <div style="font-weight: bold; color: var(--primary); margin-bottom: 10px; text-transform: uppercase; font-size: 10px; display: flex; justify-content: space-between;">
                <span>Session status</span>
                <span id="local-clock">00:00:00</span>
            </div>
            <div class="status-line"><span>Last action:</span> <span id="last-action">Ready</span></div>
            <div class="status-line"><span>Current total:</span> <span id="wp-count-display">0</span></div>
            <div class="status-line"><span>System status:</span> <div><div class="status-dot ready" id="sysDot"></div> <span id="sys-status">Ready</span></div></div>
            <div class="status-line"><span>FAA DB Sync:</span> <div><span id="dbText" style="opacity: 0.7;">Checking...</span><div class="status-dot" id="dbDot"></div></div></div>
        </div>
    </div>

    <div style="display: flex; gap: 20px; margin-bottom: 20px;">
        <div style="flex: 1;">
            <label style="font-size: 13px; font-weight: 600;">Option A: Load file</label>
            <div class="file-upload-wrapper">
                <button class="btn btn-upload" id="fileBtn">Choose File <span>.FPL .DAT .CSV .KML .RTE</span></button>
                <input type="file" id="fileInput" accept=".fpl,.dat,.csv,.txt,.kml,.wpt,.xml,.rte" onchange="updateFileNameDisplay(); processFile();">
            </div>
        </div>
        <div style="flex: 2;"><label style="font-size: 13px; font-weight: 600;">Option B: Bulk paste (use with caution):</label><textarea id="bulkInput" style="width:100%; height:42px; border-radius:6px; border:1px solid var(--border); background:var(--card); color:var(--text); padding: 5px;" placeholder="Paste coordinates here..." oninput="debouncePaste()" autocorrect="off" spellcheck="false" autocapitalize="none" autocomplete="off"></textarea></div>
    </div>

    <div class="action-bar" id="actionBar">
        <button class="btn" onclick="showMap()" style="background-color: var(--earth);">Preview on Map <span>STREET / SAT / SECTIONAL</span></button>
        <button class="btn" onclick="validateAndExportGenesys()" style="background-color: var(--success);">Export user.dat <span>GENESYS IDU</span></button>
        <button class="btn" onclick="exportToRTE()" style="background-color: #9b59b6;">Export .RTE <span>FLIGHT PLAN</span></button>
        <button class="btn" onclick="validateAndExportFPL()" style="background-color: var(--foreflight);">Export .FPL <span>FOREFLIGHT</span></button>
        <button class="btn" onclick="validateAndExportGarmin()" style="background-color: var(--garmin);">Export user.wpt <span>GARMIN GNS / GTN</span></button>
        <button class="btn" onclick="alert('CSV Exporting...')" style="background-color: var(--dispatch);">Export CSV <span>COMPLETE FLIGHT</span></button>
        <button class="btn" onclick="alert('KML Exporting...')" style="background-color: #6f42c1;">Export KML <span>GOOGLE EARTH / FOREFLIGHT</span></button>
        <div style="flex-grow: 1;"></div>
        <button class="btn btn-danger" onclick="removeAll()">CLEAR ALL DATA</button>
    </div>
    
    <table id="wpTable">
        <thead id="tableHeader">
            <tr id="headerRow">
                <th style="width: 2%;"></th> <th style="width: 2%;"></th> <th style="width: 2%;"></th> <th style="width: 3%; text-align: center;">#</th>
                <th style="width: 10%;">Identifier</th>
                <th style="width: 14%;">Name</th>
                <th style="width: 12%;" class="clickable-header" onclick="rotateCoordFormat()" id="latHeader">Latitude (DD)<br><span style="font-size: 8px; font-weight: normal; opacity: 0.7; display: block; margin-top: 2px;">Click to rotate format</span></th>
                <th style="width: 12%;" class="clickable-header" onclick="rotateCoordFormat()" id="lonHeader">Longitude (DD)<br><span style="font-size: 8px; font-weight: normal; opacity: 0.7; display: block; margin-top: 2px;">Click to rotate format</span></th>
                <th style="width: 10%;">Elevation</th>
                <th style="width: 12%;">Approach</th>
                <th style="width: 24%;">View waypoint in</th>
            </tr>
        </thead>
        <tbody id="table-body"></tbody>
    </table>

    <div style="display: flex; gap: 10px; margin-top: 10px;">
        <button class="btn btn-secondary" onclick="addRows(1)">+ Add 1 row</button>
        <button class="btn btn-secondary" onclick="addRows(5)">+ Add 5 rows</button>
        <button class="btn btn-secondary" onclick="addRows(10)">+ Add 10 rows</button>
    </div>

    <div id="mapOverlay">
        <div class="map-toggle-panel">
            <div class="toggle-item">
                <input type="checkbox" id="idToggle" onchange="toggleRouteLayer()" style="width:auto; margin:0;">
                <label for="idToggle" style="white-space:nowrap; cursor:pointer;">Show identifiers</label>
            </div>
            <div class="toggle-item" style="padding-top: 4px; border-top: 1px solid var(--border);">
                <input type="checkbox" id="routeToggle" onchange="updateMapControls()" style="width:auto; margin:0;">
                <label for="routeToggle" style="white-space:nowrap; cursor:pointer;">Show route</label>
            </div>
            <div class="toggle-item" id="legToggleContainer" style="display:none; padding-top: 4px; border-top: 1px solid var(--border);">
                <input type="checkbox" id="legToggle" onchange="toggleRouteLayer()" style="width:auto; margin:0;">
                <label for="legToggle" style="white-space:nowrap; cursor:pointer; font-size: 10px; opacity: 0.8;">Show leg data</label>
            </div>
        </div>
        <div id="map"></div>
        <div style="padding: 10px; background: var(--secondary); text-align: right;"><button class="btn btn-danger" onclick="hideMap()">Close map</button></div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
/* ---------------------------------------------------------
   APP RULES: Defines the rigid structures required for avionics binary files
   --------------------------------------------------------- */
const RECORD_SIZE = 88, HEADER_SIZE = 72, TARGET_FILE_SIZE = 88016; 
const RTE = { FILE_SIZE: 4776, HEADER_SIZE: 56, REC_SIZE: 72, NAME_START: 3032, NAME_SIZE: 31, CRC_OFFSET: 4768 };
let leafletMap = null, markerLayer = null, routeLayer = null, labelLayer = null, pasteTimer, draggedRow = null, dbReady = false; 
let lastLoadedExtension = '', coordDisplayMode = 0; 
const FAA_DB_NAME = "FAANavData", FAA_STORE_NAME = "waypoints", tbody = document.getElementById('table-body');

/* ---------------------------------------------------------
   FAA DATABASE ENGINE: Syncing waypoint data from GitHub
   --------------------------------------------------------- */
async function initAviationDB() {
    const VERSION_URL = "https://raw.githubusercontent.com/cwmauze/genesys-waypoint-tools/refs/heads/main/version.json";
    const FAA_DATA_URL = "https://raw.githubusercontent.com/cwmauze/genesys-waypoint-tools/refs/heads/main/faa_master.json";
    try {
        const vResp = await fetch(VERSION_URL); const remote = await vResp.json();
        const localCycle = localStorage.getItem('faa_cycle');
        if (remote.cycle !== localCycle) {
            updateDBStatus("loading", `Syncing ${remote.cycle}...`);
            const dResp = await fetch(FAA_DATA_URL); const data = await dResp.json();
            await saveToIndexedDB(data, remote.cycle);
        } else { updateDBStatus("ready", remote.cycle); dbReady = true; }
    } catch (e) { updateDBStatus("error", "Offline"); }
}

function saveToIndexedDB(data, cycle) {
    return new Promise((resolve) => {
        const request = indexedDB.open(FAA_DB_NAME, 1);
        request.onupgradeneeded = (e) => { e.target.result.createObjectStore(FAA_STORE_NAME, { keyPath: "id" }); };
        request.onsuccess = (e) => {
            const db = e.target.result; const tx = db.transaction(FAA_STORE_NAME, "readwrite");
            const store = tx.objectStore(FAA_STORE_NAME); data.forEach(item => store.put(item));
            tx.oncomplete = () => { localStorage.setItem('faa_cycle', cycle); updateDBStatus("ready", cycle); dbReady = true; resolve(); };
        };
    });
}

function updateDBStatus(state, text) {
    document.getElementById('dbDot').className = "status-dot " + state;
    document.getElementById('dbText').innerText = text;
}

/* ---------------------------------------------------------
   SESSION PERSISTENCE: Save/Load data locally in browser
   --------------------------------------------------------- */
function saveSession() {
    const data = [];
    tbody.querySelectorAll('tr').forEach(r => {
        const inps = r.querySelectorAll('input');
        if (inps.length >= 6) {
            data.push({
                id: inps[0].value, name: inps[1].value,
                lat: inps[2].dataset.raw || inps[2].value,
                lon: inps[3].dataset.raw || inps[3].value,
                elev: inps[4].value, app: inps[5].value
            });
        }
    });
    localStorage.setItem('genesys_session', JSON.stringify(data));
    checkGlobalHealth();
    if (leafletMap) toggleRouteLayer();
}

function loadSession() {
    const raw = localStorage.getItem('genesys_session');
    if (raw) {
        const data = JSON.parse(raw);
        if (data.length > 0) { populateTable(data); logAction("Session Restored"); }
    }
}

/* ---------------------------------------------------------
   HEALTH CHECK: Verifies coordinates are in valid ranges
   --------------------------------------------------------- */
function checkGlobalHealth() {
    const rows = tbody.querySelectorAll('tr');
    let errorCount = 0;
    rows.forEach(r => {
        const inps = r.querySelectorAll('input');
        if (inps.length >= 4) {
            const lat = parseFloat(parseCoordinate(inps[2].dataset.raw || inps[2].value));
            const lon = parseFloat(parseCoordinate(inps[3].dataset.raw || inps[3].value));
            if (lat < -90 || lat > 90 || lon < -180 || lon > 180) errorCount++;
        }
    });
    const statusText = document.getElementById('sys-status'), statusDot = document.getElementById('sysDot');
    if (errorCount > 0) {
        statusText.innerText = `${errorCount} Range Errors`;
        statusText.style.color = "var(--danger)";
        statusDot.className = "status-dot danger-pulse";
    } else {
        statusText.innerText = "System Ready";
        statusText.style.color = "";
        statusDot.className = "status-dot ready";
    }
}

/* ---------------------------------------------------------
   COORDINATE ROTATION: Switch DD / DDM / DMS viewing modes
   --------------------------------------------------------- */
function rotateCoordFormat() {
    coordDisplayMode = (coordDisplayMode + 1) % 3;
    const labels = ["(DD)", "(DDM)", "(DMS)"];
    document.getElementById('latHeader').innerHTML = `Latitude ${labels[coordDisplayMode]}<br><span style="font-size: 8px; font-weight: normal; opacity: 0.7; display: block; margin-top: 2px;">Click to rotate format</span>`;
    document.getElementById('lonHeader').innerHTML = `Longitude ${labels[coordDisplayMode]}<br><span style="font-size: 8px; font-weight: normal; opacity: 0.7; display: block; margin-top: 2px;">Click to rotate format</span>`;
    tbody.querySelectorAll('tr').forEach(r => {
        const inps = r.querySelectorAll('input');
        if (inps.length >= 4) {
            let lat = parseCoordinate(inps[2].dataset.raw || inps[2].value);
            let lon = parseCoordinate(inps[3].dataset.raw || inps[3].value);
            inps[2].dataset.raw = lat; inps[3].dataset.raw = lon;
            inps[2].value = formatCoord(lat, true); inps[3].value = formatCoord(lon, false);
        }
    });
}

function formatCoord(val, isLat) {
    let d = parseFloat(val); if (isNaN(d)) return "";
    if (coordDisplayMode === 0) return d.toFixed(6);
    let absD = Math.abs(d), deg = Math.floor(absD), minFull = (absD - deg) * 60;
    let hemi = isLat ? (d >= 0 ? 'N' : 'S') : (d >= 0 ? 'E' : 'W');
    if (coordDisplayMode === 1) return `${deg}° ${minFull.toFixed(3)}' ${hemi}`;
    let min = Math.floor(minFull), sec = (minFull - min) * 60;
    return `${deg}° ${min}' ${sec.toFixed(1)}" ${hemi}`;
}

/* ---------------------------------------------------------
   FILE PROCESSING: Detects file type and assigns parser
   --------------------------------------------------------- */
function updateFileNameDisplay() {
    const f = document.getElementById('fileInput'), b = document.getElementById('fileBtn');
    if (f.files.length > 0) { b.innerHTML = `Loaded: ${f.files[0].name} <span>CHANGE FILE</span>`; }
}

function processFile() {
    const f = document.getElementById('fileInput');
    if (f.files.length > 0) {
        const file = f.files[0], reader = new FileReader(), ext = file.name.toLowerCase().split('.').pop();
        lastLoadedExtension = ext;
        reader.onload = e => {
            if (ext === 'dat') decodeBinary(e.target.result);
            else if (ext === 'rte') decodeRTE(e.target.result); 
            else if (ext === 'fpl') parseFPL(e.target.result); 
            else if (ext === 'kml' || ext === 'xml') parseKML(e.target.result);
            else smartParse(e.target.result);
            logAction("Loaded " + file.name);
        };
        (ext === 'dat' || ext === 'rte') ? reader.readAsArrayBuffer(file) : reader.readAsText(file);
    }
}

/* ---------------------------------------------------------
   IMPORT ENGINE: ForeFlight .FPL XML mapping
   --------------------------------------------------------- */
function parseFPL(text) {
    const parser = new DOMParser(), xml = parser.parseFromString(text, "text/xml"), wps = [], wpLookup = {};
    const tablePoints = xml.querySelectorAll("waypoint");
    tablePoints.forEach(wp => {
        const id = wp.querySelector("identifier")?.textContent;
        const lat = wp.querySelector("lat")?.textContent;
        const lon = wp.querySelector("lon")?.textContent;
        if (id) wpLookup[id] = { lat: parseFloat(lat).toFixed(6), lon: parseFloat(lon).toFixed(6) };
    });
    const routePoints = xml.querySelectorAll("route-point");
    routePoints.forEach(rp => {
        const id = rp.querySelector("waypoint-identifier")?.textContent;
        if (id && wpLookup[id]) wps.push({ id: id, name: "", lat: wpLookup[id].lat, lon: wpLookup[id].lon });
    });
    if (wps.length > 0) {
        populateTable(wps);
        document.getElementById('routeToggle').checked = true;
        updateMapControls();
    }
}

/* ---------------------------------------------------------
   IMPORT ENGINE: Genesys user.dat (Byte Decoder)
   --------------------------------------------------------- */
function decodeBinary(buf) {
    const v = new DataView(buf), count = v.getUint32(0, true), wps = [];
    for (let i = 0; i < count; i++) {
        let off = HEADER_SIZE + (i * RECORD_SIZE), id = "", nm = "";
        for (let j = 0; j < 9; j++) { let c = v.getUint8(off + 24 + j); if (c !== 0) id += String.fromCharCode(c); }
        for (let j = 0; j < 23; j++) { let c = v.getUint8(off + 33 + j); if (c !== 0) nm += String.fromCharCode(c); }
        wps.push({ id: id.trim(), name: nm.trim(), lat: v.getFloat64(off + 72, true).toFixed(6), lon: v.getFloat64(off + 80, true).toFixed(6) });
    }
    populateTable(wps);
}

function decodeRTE(buf) {
    const view = new DataView(buf), bytes = new Uint8Array(buf), count = view.getUint32(0, true), wps = [];
    for (let i = 0; i < count; i++) {
        let cOff = RTE.HEADER_SIZE + (i * RTE.REC_SIZE);
        let lat = view.getFloat64(cOff + 24, true), lon = view.getFloat64(cOff + 32, true);
        let nOff = RTE.NAME_START + (i * RTE.NAME_SIZE), name = readRTEString(bytes, nOff, RTE.NAME_SIZE);
        let idOff = RTE.HEADER_SIZE + ((i + 1) * RTE.REC_SIZE) + 8, id = readRTEString(bytes, idOff, 6);
        wps.push({ id: id || "WP"+(i+1), name, lat: lat.toFixed(6), lon: lon.toFixed(6) });
    }
    populateTable(wps);
}

function readRTEString(bytes, offset, length) {
    let str = ""; for (let i = 0; i < length; i++) { let c = bytes[offset + i]; if (c === 0) break; if (c >= 32 && c <= 126) str += String.fromCharCode(c); } return str.trim();
}

/* ---------------------------------------------------------
   IMPORT ENGINE: .KML / .XML (Standard Earth format)
   --------------------------------------------------------- */
function parseKML(text) {
    const parser = new DOMParser(), xml = parser.parseFromString(text, "text/xml"), wps = [];
    const pms = xml.querySelectorAll("Placemark");
    pms.forEach(pm => {
        const name = pm.querySelector("name")?.textContent || "WP";
        const coordTxt = pm.querySelector("coordinates")?.textContent.trim();
        if (coordTxt) { const parts = coordTxt.split(","); wps.push({ id: name.substring(0,5), name: name, lat: parts[1], lon: parts[0] }); }
    });
    populateTable(wps);
}

/* ---------------------------------------------------------
   IMPORT ENGINE: Smart Text Parser (Regex coordinate extractor)
   --------------------------------------------------------- */
function smartParse(text) {
    const wps = [];
    const ddmPattern = /(\d{1,3}\s+\d{1,2}\.\d{1,4}\s*[NS])\s*(\d{1,3}\s+\d{1,2}\.\d{1,4}\s*[EW])/gi;
    const decimalPattern = /(\d{2}\.\d{6,})(-\d{2,3}\.\d{6,})/g;
    let match, lastIndex = 0;
    while ((match = ddmPattern.exec(text)) !== null) {
        let gapText = text.substring(lastIndex, match.index).trim(), id = "WP", name = "", lines = gapText.split(/\r?\n/), lastLine = lines[lines.length-1].trim().replace(/[,\s|;]+$/, "");
        if (lastLine) {
            let parts = lastLine.split(/[,\t|;]/); id = parts[0].trim().substring(0, 5).toUpperCase();
            if (parts.length >= 2) name = parts[1].trim();
            else { let spaceParts = parts[0].trim().split(/\s+/); if (spaceParts.length >= 2) { id = spaceParts[0].substring(0, 5).toUpperCase(); name = spaceParts.slice(1).join(" "); } }
        }
        if (name.toUpperCase() === id) name = "";
        wps.push({ id: id, name: name || "Import", lat: parseCoordinate(match[1]), lon: parseCoordinate(match[2]) });
        lastIndex = ddmPattern.lastIndex;
    }
    if (wps.length === 0) {
        while ((match = decimalPattern.exec(text)) !== null) {
            let lookback = text.substring(Math.max(0, match.index - 15), match.index).trim().replace(/[,\s|;]+$/, ""), id = "WP", name = "", parts = lookback.split(/[,\t|;]/), lastPart = parts[parts.length-1].trim();
            if (lastPart) { let spaceParts = lastPart.split(/\s+/); id = spaceParts[0].substring(0, 5).toUpperCase(); if (spaceParts.length >= 2) name = spaceParts.slice(1).join(" "); }
            if (name.toUpperCase() === id) name = "";
            wps.push({ id: id, name: name || "Import", lat: parseFloat(match[1]).toFixed(6), lon: parseFloat(match[2]).toFixed(6) });
        }
    }
    if (wps.length === 0) {
        const lines = text.split(/\r?\n/), stdPattern = /(-?\d{1,3}[°\s\-\.][0-6]?\d[\s\-\.][0-6]?\d?\.?\d*[N|S|E|W]?)|(-?\d{1,3}\.\d{4,})/gi;
        lines.forEach(l => {
            const m = l.match(stdPattern);
            if (m && m.length >= 2) {
                let id = "WP", name = "", firstCoordIdx = l.indexOf(m[0]), before = l.substring(0, firstCoordIdx).trim().replace(/[,\s|;]+$/, "");
                if (before) {
                    let parts = before.split(/[,\t|;]/); id = parts[0].trim().substring(0, 5).toUpperCase();
                    if (parts.length >= 2) name = parts[1].trim();
                    else { let spaceParts = parts[0].trim().split(/\s+/); if (spaceParts.length >= 2) { id = spaceParts[0].substring(0, 5).toUpperCase(); name = spaceParts.slice(1).join(" "); } }
                }
                if (name.toUpperCase() === id) name = "";
                wps.push({ id: id, name: name || "Import", lat: parseCoordinate(m[0]), lon: parseCoordinate(m[1]) });
            }
        });
    }
    populateTable(wps);
}

function populateTable(wps) {
    tbody.innerHTML = '';
    wps.forEach(wp => { const r = document.createElement('tr'); createRowCells(r, wp); tbody.appendChild(r); });
    updateRowNumbers(); updateColumnVisibility(); saveSession();
}

function handleTablePaste(targetInput, e) {
    const pasteData = (e.clipboardData || window.clipboardData).getData('text');
    if (!pasteData.includes('\n') && !pasteData.includes('\t')) return; 
    e.preventDefault();
    const rows = pasteData.split(/\r?\n/).filter(line => line.length > 0);
    const currentRow = targetInput.closest('tr'), currentColIdx = Array.from(currentRow.querySelectorAll('input')).indexOf(targetInput);
    let targetRow = currentRow;
    rows.forEach((rowContent, rIdx) => {
        if (!targetRow) { addRows(1); targetRow = tbody.lastElementChild; }
        const cells = rowContent.split('\t'), rowInputs = targetRow.querySelectorAll('input');
        cells.forEach((cellVal, cIdx) => {
            const inputIdx = currentColIdx + cIdx;
            if (rowInputs[inputIdx]) {
                let cleanVal = cellVal.trim();
                if (inputIdx === 0) cleanVal = cleanVal.substring(0, 5).toUpperCase();
                rowInputs[inputIdx].value = cleanVal;
                rowInputs[inputIdx].dispatchEvent(new Event('input')); 
            }
        });
        targetRow = targetRow.nextElementSibling;
    });
    saveSession();
}

function validateInput(input, type) {
    const val = parseFloat(parseCoordinate(input.value));
    const isError = type === 'lat' ? (val < -90 || val > 90) : (val < -180 || val > 180);
    input.style.backgroundColor = isError ? "rgba(251, 97, 97, 0.2)" : "";
    checkGlobalHealth();
}

function handleAutocomplete(input) {
    if (!dbReady) return;
    const query = input.value.trim().toUpperCase();
    const list = input.parentElement.querySelector('.autocomplete-list') || document.createElement('div');
    list.className = 'autocomplete-list';
    if (!input.parentElement.contains(list)) input.parentElement.appendChild(list);
    if (query.length < 2) { list.style.display = 'none'; return; }
    const request = indexedDB.open(FAA_DB_NAME, 1);
    request.onsuccess = (e) => {
        const db = e.target.result;
        const tx = db.transaction(FAA_STORE_NAME, "readonly"), store = tx.objectStore(FAA_STORE_NAME);
        const range = IDBKeyRange.bound(query, query + '\uffff');
        const matches = [];
        store.openCursor(range).onsuccess = (ev) => {
            const cursor = ev.target.result;
            if (cursor && matches.length < 5) { matches.push(cursor.value); cursor.continue(); } 
            else { renderMatches(matches, list, input); }
        };
    };
}

function renderMatches(matches, list, input) {
    if (matches.length === 0) { list.style.display = 'none'; return; }
    list.innerHTML = '';
    matches.forEach(m => {
        const item = document.createElement('div');
        item.className = 'autocomplete-item';
        item.innerText = `${m.id} - ${m.name} (${m.type})`;
        item.onclick = () => {
            const row = input.closest('tr');
            const inps = row.querySelectorAll('input');
            applyDataToRow(m, inps, row);
            list.style.display = 'none';
        };
        list.appendChild(item);
    });
    list.style.display = 'block';
}

/* ---------------------------------------------------------
   FUNCTION: CREATE ROW CELLS
   Builds the table rows, including handles for Delete, Insert (Above), and Drag.
   --------------------------------------------------------- */
function createRowCells(r, wp) {
    r.draggable = true;
    r.addEventListener('dragstart', (e) => { draggedRow = r; setTimeout(() => r.classList.add('dragging'), 0); });
    r.addEventListener('dragend', () => { draggedRow = null; r.classList.remove('dragging'); updateRowNumbers(); saveSession(); });
    r.addEventListener('dragover', (e) => { e.preventDefault(); r.classList.add('drag-over'); });
    r.addEventListener('dragleave', () => r.classList.remove('drag-over'));
    r.addEventListener('drop', (e) => {
        e.preventDefault(); r.classList.remove('drag-over');
        if (r !== draggedRow) {
            const all = [...tbody.querySelectorAll('tr')];
            if (all.indexOf(draggedRow) < all.indexOf(r)) r.after(draggedRow); else r.before(draggedRow);
            saveSession();
        }
    });

    // Col 0: DELETE Handle (Subtle Red X)
    const delCell = r.insertCell(0);
    delCell.className = 'delete-btn';
    delCell.innerText = '✕';
    delCell.title = "Delete Row";
    delCell.onclick = () => { r.remove(); updateRowNumbers(); saveSession(); checkGlobalHealth(); updateColumnVisibility(); };

    // Col 1: INSERT Handle (Subtle Plus Icon) - v8.2.1.25 updated to insert ABOVE
    const insCell = r.insertCell(1);
    insCell.className = 'insert-btn';
    insCell.innerText = '+';
    insCell.title = "Insert Row Above";
    insCell.onclick = () => {
        const newRow = document.createElement('tr');
        createRowCells(newRow, {id:'', name:'', lat:'', lon:''});
        r.before(newRow); // Logical change: .before instead of .after
        updateRowNumbers();
        saveSession();
    };

    // Col 2: DRAG Handle
    r.insertCell(2).className = 'drag-handle'; r.cells[2].innerText = '⠿';
    
    // Col 3: SEQUENCE NUMBER
    r.insertCell(3).className = 'row-number';
    
    // Cols 4-9: DATA INPUT FIELDS
    [wp.id, wp.name, wp.lat, wp.lon, wp.elev || '0', wp.app || '0'].forEach((v, i) => {
        const cell = r.insertCell(i+4); const input = document.createElement('input'); 
        input.setAttribute('autocorrect', 'off'); input.setAttribute('spellcheck', 'false');
        input.setAttribute('autocapitalize', 'none'); input.setAttribute('autocomplete', 'off');
        if (i === 2 || i === 3) { input.dataset.raw = v; input.value = formatCoord(v, i === 2); } else { input.value = v || ''; }
        input.addEventListener('paste', (e) => handleTablePaste(input, e));
        if(i === 0) { 
            input.style.textTransform = "uppercase"; 
            input.addEventListener('input', () => { input.value = input.value.toUpperCase(); handleAutocomplete(input); setupIdLookup(input); });
            document.addEventListener('click', (e) => { if (!cell.contains(e.target)) { const l = cell.querySelector('.autocomplete-list'); if(l) l.style.display='none'; } });
        }
        input.oninput = () => { 
            if(i === 2 || i === 3) { input.dataset.raw = parseCoordinate(input.value); validateInput(input, i === 2 ? 'lat' : 'lon'); }
            updateQuickLinks(r); saveSession(); 
        }; 
        cell.appendChild(input);
    });
    const lC = r.insertCell(10); lC.className = 'quick-links'; updateQuickLinks(r);
}

function setupIdLookup(input) {
    let timer;
    input.addEventListener('input', () => {
        clearTimeout(timer); const row = input.closest('tr'), inps = row.querySelectorAll('input');
        timer = setTimeout(async () => {
            let id = input.value.trim().toUpperCase(); if (id === "" || id.length < 3 || !dbReady) return;
            const req = indexedDB.open(FAA_DB_NAME, 1);
            req.onsuccess = (e) => {
                const db = e.target.result; const tx = db.transaction(FAA_STORE_NAME, "readonly"), store = tx.objectStore(FAA_STORE_NAME);
                const getRequest = store.get(id);
                getRequest.onsuccess = () => { let res = getRequest.result; if (res) applyDataToRow(res, inps, row); };
            };
        }, 400);
    });
}

/* ---------------------------------------------------------
   TRUTH-FIRST LOGIC: Ensures DB never overwrites file data
   --------------------------------------------------------- */
function applyDataToRow(res, inps, row) {
    const curLat = inps[2].value.trim(), curLon = inps[3].value.trim();
    if (curLat === "" || curLat === "0" || curLat === "0.000000") {
        let fixedLat = Math.abs(parseFloat(res.lat));
        inps[2].dataset.raw = fixedLat; inps[2].value = formatCoord(fixedLat, true);
    }
    if (curLon === "" || curLon === "0" || curLon === "0.000000") {
        let fixedLon = -Math.abs(parseFloat(res.lon));
        inps[3].dataset.raw = fixedLon; inps[3].value = formatCoord(fixedLon, false);
    }
    if (inps[1].value.trim() === "") inps[1].value = (res.type === 'FIX' || res.type === 'INT') ? "" : res.name;
    if (inps[4].value.trim() === "" || inps[4].value === "0") inps[4].value = (res.type === 'APT') ? Math.round(parseFloat(res.elev) || 0) : 0;
    inps.forEach((inp, idx) => { if(idx > 0 && idx < 5) inp.style.backgroundColor = "rgba(71, 141, 245, 0.1)"; });
    updateQuickLinks(row); saveSession();
}

function updateQuickLinks(r) {
    const i = r.querySelectorAll('input'); if(i.length < 4) return;
    const lat = parseCoordinate(i[2].dataset.raw || i[2].value), lon = parseCoordinate(i[3].dataset.raw || i[3].value);
    const c = r.querySelector('.quick-links');
    if (!isNaN(lat) && lat !== 0) {
        c.innerHTML = `<a href="https://plan.foreflight.com/map#${lon}/${lat}/14" target="_blank">ForeFlight</a> <span class="separator">|</span> <a href="https://earth.google.com/web/search/${lat},${lon}" target="_blank">Google Earth</a> <span class="separator">|</span> <a href="http://maps.google.com/maps?q=${lat},${lon}" target="_blank">Google Maps</a>`;
    } else { c.innerHTML = ""; }
}

function parseCoordinate(i) {
    if (!i) return 0; let s = i.toString().trim().toUpperCase(), m = (/[SW-]/.test(s)) ? -1 : 1;
    let p = s.replace(/[NSWE°'"\-]/g, ' ').trim().split(/\s+/), d = 0;
    if (p.length === 1) d = parseFloat(p[0]); else if (p.length === 2) d = parseFloat(p[0]) + (parseFloat(p[1])/60); else if (p.length >= 3) d = parseFloat(p[0]) + (parseFloat(p[1])/60) + (parseFloat(p[2])/3600);
    return (Math.abs(d) * m).toFixed(6);
}

/* ---------------------------------------------------------
   MAP ENGINE: Leaflet connection and layer management
   --------------------------------------------------------- */
function updateMapControls() {
    const routeOn = document.getElementById('routeToggle').checked;
    const legContainer = document.getElementById('legToggleContainer');
    legContainer.style.display = routeOn ? 'flex' : 'none';
    if (!routeOn) document.getElementById('legToggle').checked = false;
    if (routeOn) document.getElementById('idToggle').checked = true;
    toggleRouteLayer();
}

function calculateLegData(p1, p2) {
    const R = 3440.065; const rad = Math.PI / 180;
    const lat1 = p1[0] * rad, lat2 = p2[0] * rad;
    const dLat = (p2[0] - p1[0]) * rad, dLon = (p2[1] - p1[1]) * rad;
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1) * Math.cos(lat2) * Math.sin(dLon/2) * Math.sin(dLon/2);
    const dist = (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)) * R).toFixed(1);
    const y = Math.sin(dLon) * Math.cos(lat2), x = Math.cos(lat1) * Math.sin(lat2) - Math.sin(lat1) * Math.cos(lat2) * Math.cos(dLon);
    let brg = (Math.atan2(y, x) / rad + 360) % 360;
    return `${dist} nm | ${Math.round(brg).toString().padStart(3, '0')}°`;
}

function showMap() {
    document.getElementById('mapOverlay').style.display = 'block';
    const routeToggle = document.getElementById('routeToggle');
    routeToggle.checked = (lastLoadedExtension === 'rte' || lastLoadedExtension === 'fpl');
    if (!leafletMap) {
        leafletMap = L.map('map').setView([39.8, -98.5], 4);
        const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {attribution: 'OSM'}), 
              sat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {attribution: 'Esri'}), 
              sec = L.tileLayer('https://tiles.arcgis.com/tiles/ssFJjBXIUyZDrSYZ/arcgis/rest/services/VFR_Sectional/MapServer/tile/{z}/{y}/{x}', {attribution: 'FAA'});
        osm.addTo(leafletMap); L.control.layers({ "Street": osm, "Satellite": sat, "Sectional": sec }, null, { position: 'bottomright' }).addTo(leafletMap);
        markerLayer = L.layerGroup().addTo(leafletMap); routeLayer = L.polyline([], {color: 'magenta', weight: 3}).addTo(leafletMap); labelLayer = L.layerGroup().addTo(leafletMap);
    }
    leafletMap.invalidateSize(); updateMapControls(); toggleRouteLayer(true); 
}

function toggleRouteLayer(isInitial = false) {
    if (!leafletMap || !routeLayer || !markerLayer || !labelLayer) return;
    const isRouteEnabled = document.getElementById('routeToggle').checked, isLegDataEnabled = document.getElementById('legToggle').checked, isIDToggleEnabled = document.getElementById('idToggle').checked;
    const coords = []; let bounds = []; markerLayer.clearLayers(); routeLayer.setLatLngs([]); labelLayer.clearLayers();
    tbody.querySelectorAll('tr').forEach((r, idx) => {
        const inps = r.querySelectorAll('input');
        if (inps.length >= 4) {
            const lat = parseFloat(parseCoordinate(inps[2].dataset.raw || inps[2].value)), lon = parseFloat(parseCoordinate(inps[3].dataset.raw || inps[3].value));
            if (!isNaN(lat) && lat !== 0) {
                const pos = [lat, lon]; coords.push(pos); bounds.push(pos);
                let popupContent = `<b>${inps[0].value || 'WP'}</b>`;
                if (!isRouteEnabled && inps[1].value) popupContent += `<div style="font-size: 11px; margin-top: 2px; opacity: 0.8; border-top: 1px solid rgba(0,0,0,0.1); padding-top: 2px;">${inps[1].value}</div>`;
                const markerOpts = isRouteEnabled ? {icon: L.divIcon({className: 'numbered-marker', html: (idx + 1), iconSize: [20, 20]})} : {};
                const marker = L.marker(pos, markerOpts).addTo(markerLayer).bindPopup(popupContent);
                if (isIDToggleEnabled) marker.bindTooltip(inps[0].value || `WP${idx+1}`, { permanent: true, direction: 'top', offset: [0, -10] });
            }
        }
    });
    if (isRouteEnabled && coords.length > 1) {
        routeLayer.setLatLngs(coords);
        if (isLegDataEnabled) {
            for (let i = 0; i < coords.length - 1; i++) {
                const midLat = (coords[i][0] + coords[i+1][0]) / 2, midLon = (coords[i][1] + coords[i+1][1]) / 2;
                const legInfo = calculateLegData(coords[i], coords[i+1]);
                L.marker([midLat, midLon], { icon: L.divIcon({ className: 'leg-label', html: legInfo, iconSize: [70, 20], iconAnchor: [35, 10] }) }).addTo(labelLayer);
            }
        }
    }
    if (isInitial && bounds.length > 0) leafletMap.fitBounds(bounds, {padding: [50, 50]});
}

/* ---------------------------------------------------------
   UI HELPERS: Reset, Row Counting, and Theme Swapping
   --------------------------------------------------------- */
function toggleVersionHistory() {
    const overlay = document.getElementById('historyOverlay'), box = document.getElementById('versionHistory');
    const isShowing = overlay.style.display === 'block'; overlay.style.display = isShowing ? 'none' : 'block'; box.style.display = isShowing ? 'none' : 'block';
}
function startClock() { setInterval(() => { document.getElementById('local-clock').innerText = new Date().toLocaleTimeString('en-GB', { hour12: false }); }, 1000); }
function updateRowNumbers() { tbody.querySelectorAll('tr').forEach((r, i) => { if(r.cells[3]) r.cells[3].innerText = i + 1; }); }
function updateColumnVisibility() { document.getElementById('actionBar').style.display = tbody.rows.length > 0 ? 'flex' : 'none'; }
function logAction(a) { document.getElementById('last-action').innerText = a; document.getElementById('wp-count-display').innerText = tbody.querySelectorAll('tr').length; }

function removeAll() {
    if (confirm("Clear all data? This will reset the table and all input fields.")) {
        tbody.innerHTML = ''; localStorage.removeItem('genesys_session');
        const bulk = document.getElementById('bulkInput'); if (bulk) bulk.value = '';
        const fInp = document.getElementById('fileInput'); if (fInp) fInp.value = '';
        const fBtn = document.getElementById('fileBtn'); if (fBtn) fBtn.innerHTML = `Choose File <span>.FPL .DAT .CSV .KML .RTE</span>`;
        lastLoadedExtension = ''; updateColumnVisibility(); logAction("System Reset"); checkGlobalHealth();
    }
}

function debouncePaste() { clearTimeout(pasteTimer); pasteTimer = setTimeout(() => { if(document.getElementById('bulkInput').value) smartParse(document.getElementById('bulkInput').value); }, 500); }
function addRows(n) { for(let i=0; i<n; i++){ const r = document.createElement('tr'); createRowCells(r, {id:'', name:'', lat:'', lon:''}); tbody.appendChild(r); } updateRowNumbers(); updateColumnVisibility(); saveSession(); }

function toggleTheme() { 
    const isNowLight = document.body.getAttribute('data-theme') !== 'light'; 
    document.body.setAttribute('data-theme', isNowLight ? 'light' : 'dark'); 
    document.getElementById('themeBtn').innerText = isNowLight ? '🌙' : '☀️'; 
}

function hideMap() { document.getElementById('mapOverlay').style.display = 'none'; }
function initStickyObserver() {
    const observer = new ResizeObserver(entries => { const h = entries[0].target.offsetHeight; document.querySelectorAll('#tableHeader th').forEach(th => th.style.top = h + 'px'); });
    observer.observe(document.getElementById('actionBar'));
}

/* ---------------------------------------------------------
   EXPORT HANDLERS: Binary, CSV, and XML generation
   --------------------------------------------------------- */
function validateAndExportGenesys() {
    const rows = [...tbody.querySelectorAll('tr')], headerHex = "9a01000000000000000000002000000000000000002000000000000000000000000000000000000000000000000000000a00000000000004728a3b76555424027eadf08657853c0";
    let bytes = []; let hBuf = new ArrayBuffer(HEADER_SIZE), hView = new DataView(hBuf); hView.setUint32(0, rows.length, true);
    for(let k=0; k<HEADER_SIZE; k++) bytes.push(k<4 ? hView.getUint8(k) : parseInt(headerHex.substr(k*2,2), 16));
    rows.forEach(r => {
        const inp = r.querySelectorAll('input'); const lat = parseCoordinate(inp[2].dataset.raw || inp[2].value), lon = parseCoordinate(inp[3].dataset.raw || inp[3].value);
        let buf = new ArrayBuffer(RECORD_SIZE), v = new DataView(buf);
        for(let j=0; j<9; j++) v.setUint8(24+j, (j<inp[0].value.length)?inp[0].value.charCodeAt(j):0);
        for(let j=0; j<23; j++) v.setUint8(33+j, (j<inp[1].value.length)?inp[1].value.charCodeAt(j):0);
        v.setFloat64(72, parseFloat(lat), true); v.setFloat64(80, parseFloat(lon), true);
        for(let k=0; k<RECORD_SIZE; k++) bytes.push(v.getUint8(k));
    });
    while(bytes.length < TARGET_FILE_SIZE - 8) bytes.push(0);
    const table = makeCRCTable(); let crc = 0xFFFFFFFF; for(let i=0; i<bytes.length; i++) crc = (crc >>> 8) ^ table[(crc ^ bytes[i]) & 0xFF];
    crc = (crc ^ 0xFFFFFFFF) >>> 0; let cBuf = new ArrayBuffer(4), cView = new DataView(cBuf); cView.setUint32(0, crc, true);
    for(let k=0; k<4; k++) bytes.push(cView.getUint8(k)); bytes.push(0,0,0,0);
    const a = document.createElement("a"); a.href = URL.createObjectURL(new Blob([new Uint8Array(bytes)])); a.download = "user.dat"; a.click();
}
function makeCRCTable(){let c, t=[];for(let n=0;n<256;n++){c=n;for(let k=0;k<8;k++)c=((c&1)?(0xEDB88320^(c>>>1)):(c>>>1));t[n]=c;}return t;}

function exportToRTE() {
    const rows = [...tbody.querySelectorAll('tr')]; if (rows.length < 2) return alert("Min 2 WPs");
    let buf = new ArrayBuffer(RTE.FILE_SIZE), v = new DataView(buf); v.setUint32(0, rows.length, true);
    rows.forEach((r, i) => {
        const inp = r.querySelectorAll('input'); let cOff = RTE.HEADER_SIZE + (i * RTE.REC_SIZE);
        v.setFloat64(cOff + 24, parseFloat(parseCoordinate(inp[2].dataset.raw || inp[2].value)), true); v.setFloat64(cOff + 32, parseFloat(parseCoordinate(inp[3].dataset.raw || inp[3].value)), true);
    });
    const a = document.createElement("a"); a.href = URL.createObjectURL(new Blob([buf])); a.download = "plan.rte"; a.click();
}

async function validateAndExportFPL() {
    const rows = [...tbody.querySelectorAll('tr')];
    if (rows.length < 2) return alert("Min 2 waypoints required.");
    const now = new Date().toISOString().split('.')[0].replace(/[:-]/g, '') + 'Z';
    const firstID = rows[0].querySelectorAll('input')[0].value.trim().toUpperCase() || 'START';
    const lastID = rows[rows.length-1].querySelectorAll('input')[0].value.trim().toUpperCase() || 'END';
    let xml = `<?xml version="1.0" encoding="utf-8"?>\n<flight-plan xmlns="http://www8.garmin.com/xmlschemas/FlightPlan/v1">\n<created>${now}</created>\n<aircraft><aircraft-tailnumber>USER</aircraft-tailnumber></aircraft>\n<flight-data><altitude-ft>2000</altitude-ft></flight-data>\n<waypoint-table>\n`;
    const getDBType = (id) => {
        return new Promise((resolve) => {
            const request = indexedDB.open(FAA_DB_NAME, 1);
            request.onsuccess = (e) => {
                const db = e.target.result;
                const tx = db.transaction(FAA_STORE_NAME, "readonly"), store = tx.objectStore(FAA_STORE_NAME);
                const getReq = store.get(id);
                getReq.onsuccess = () => {
                    const res = getReq.result;
                    if (!res) resolve((id.length <= 4 && (id.startsWith('K') || id.startsWith('P'))) ? "AIRPORT" : "INT");
                    else if (res.type === 'APT') resolve("AIRPORT");
                    else if (res.type === 'VOR' || res.type === 'DME') resolve("VOR");
                    else resolve("INT");
                };
            };
        });
    };
    for (const r of rows) {
        const inps = r.querySelectorAll('input'); const id = inps[0].value.trim().toUpperCase();
        const lat = parseFloat(inps[2].dataset.raw || inps[2].value).toFixed(6), lon = parseFloat(inps[3].dataset.raw || inps[3].value).toFixed(6);
        const type = await getDBType(id);
        xml += `    <waypoint>\n        <identifier>${id}</identifier>\n        <type>${type}</type>\n        <lat>${lat}</lat>\n        <lon>${lon}</lon>\n    </waypoint>\n`;
    }
    xml += `</waypoint-table>\n<route>\n    <route-name>${firstID}-${lastID}</route-name>\n    <flight-plan-index>1</flight-plan-index>\n`;
    for (const r of rows) {
        const id = r.querySelectorAll('input')[0].value.trim().toUpperCase();
        const type = await getDBType(id);
        xml += `    <route-point>\n        <waypoint-identifier>${id}</waypoint-identifier>\n        <waypoint-type>${type}</waypoint-type>\n    </route-point>\n`;
    }
    xml += `</route>\n</flight-plan>`;
    const a = document.createElement("a"); a.href = URL.createObjectURL(new Blob([xml], {type:'text/xml'})); a.download = `${firstID}-${lastID}.fpl`; a.click();
}

function validateAndExportGarmin() {
    let csv = ""; tbody.querySelectorAll('tr').forEach(r => {
        const inp = r.querySelectorAll('input'); csv += `${inp[0].value},${inp[1].value},${parseCoordinate(inp[2].dataset.raw || inp[2].value)},${parseCoordinate(inp[3].dataset.raw || inp[3].value)}\n`;
    });
    const a = document.createElement("a"); a.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'})); a.download = "user.wpt"; a.click();
}
</script>
</body>
</html>
